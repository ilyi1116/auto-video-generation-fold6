# HAProxy 高可用性負載均衡配置
# 企業級負載均衡和故障轉移

global
    daemon
    log stdout len 65536 local0 info
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    
    # SSL/TLS 配置
    ssl-default-bind-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    mode http
    log global
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout http-request 10s
    timeout http-keep-alive 2s
    timeout queue 30s
    timeout check 5s
    
    # 錯誤處理
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# 統計頁面
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats auth admin:${HAPROXY_STATS_PASSWORD}

# 主要前端 - HTTP
frontend auto_video_http
    bind *:80
    
    # 安全標頭
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-Frame-Options DENY
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # HTTP 重定向到 HTTPS
    redirect scheme https code 301 if !{ ssl_fc }

# 主要前端 - HTTPS
frontend auto_video_https
    bind *:443 ssl crt /etc/ssl/certs/auto-video.pem
    
    # 安全標頭
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-Frame-Options DENY
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # ACL 規則
    acl is_api path_beg /api/
    acl is_admin path_beg /admin/
    acl is_health path_beg /health
    acl is_metrics path_beg /metrics
    
    # 路由規則
    use_backend api_backend if is_api
    use_backend admin_backend if is_admin
    use_backend health_backend if is_health
    use_backend metrics_backend if is_metrics
    default_backend web_backend

# API Gateway 前端
frontend api_gateway
    bind *:8080
    
    # 速率限制
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request reject if { sc_http_req_rate(0) gt 100 }
    
    # 健康檢查
    acl is_health path /health
    use_backend health_backend if is_health
    
    default_backend api_gateway_backend

# API Gateway 後端
backend api_gateway_backend
    balance roundrobin
    
    # 健康檢查
    option httpchk GET /health HTTP/1.1\r\nHost:\ localhost
    http-check expect status 200
    
    # 重試配置
    retries 3
    option redispatch
    
    # 服務器配置
    server api-gateway-1 api-gateway-1:8080 check inter 10s rise 2 fall 3 weight 100
    server api-gateway-2 api-gateway-2:8080 check inter 10s rise 2 fall 3 weight 100
    
    # 備用服務器（降級模式）
    server api-gateway-backup api-gateway-backup:8080 check inter 30s rise 2 fall 5 weight 50 backup

# Web 前端後端
backend web_backend
    balance roundrobin
    
    # 會話親和性
    cookie SERVERID insert indirect nocache
    
    server web-1 frontend:3000 check cookie web-1
    server web-2 frontend-2:3000 check cookie web-2 backup

# AI 服務後端
backend ai_service_backend
    balance leastconn  # AI 服務使用最少連接負載均衡
    
    # 健康檢查
    option httpchk GET /health HTTP/1.1\r\nHost:\ localhost
    http-check expect status 200
    
    # 超時配置（AI 服務需要更長時間）
    timeout server 60s
    timeout connect 10s
    
    server ai-service-1 ai-service-1:8001 check inter 15s rise 2 fall 3 weight 100 maxconn 10
    server ai-service-2 ai-service-2:8001 check inter 15s rise 2 fall 3 weight 100 maxconn 10

# 影片服務後端
backend video_service_backend
    balance roundrobin
    
    # 健康檢查
    option httpchk GET /health HTTP/1.1\r\nHost:\ localhost
    http-check expect status 200
    
    # 超時配置（影片處理需要更長時間）
    timeout server 120s
    timeout connect 10s
    
    server video-service-1 video-service-1:8003 check inter 20s rise 2 fall 3 weight 100 maxconn 5
    server video-service-2 video-service-2:8003 check inter 20s rise 2 fall 3 weight 100 maxconn 5

# 管理後端
backend admin_backend
    balance roundrobin
    
    # 管理界面安全限制
    acl authorized_admin src 10.0.0.0/8 192.168.0.0/16 172.16.0.0/12
    http-request deny if !authorized_admin
    
    server admin-1 admin-service:8080 check

# 健康檢查後端
backend health_backend
    balance roundrobin
    
    server health-1 health-monitor:8080 check
    server health-2 health-monitor-2:8080 check backup

# 指標收集後端
backend metrics_backend
    balance roundrobin
    
    # 指標端點安全限制
    acl authorized_metrics src 10.0.0.0/8 192.168.0.0/16 172.16.0.0/12
    http-request deny if !authorized_metrics
    
    server prometheus prometheus:9090 check
    server grafana grafana:3000 check backup

# 錯誤頁面配置
backend error_backend
    http-request return status 503 content-type "application/json" string "{\"error\":\"Service Temporarily Unavailable\",\"code\":503}"

# 全局錯誤處理
backend maintenance_backend
    http-request return status 503 content-type "text/html" file /etc/haproxy/maintenance.html

# 監控和日誌配置
listen prometheus_exporter
    bind *:9101
    http-request use-service prometheus-exporter
    no option httplog