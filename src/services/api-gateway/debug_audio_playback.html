<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é »æ’­æ”¾è¨ºæ–·å·¥å…·</title>
    <style>
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            margin: 40px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.1s;
        }
        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        .time-display {
            font-family: monospace;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ éŸ³é »æ’­æ”¾è¨ºæ–·å·¥å…·</h1>
        
        <div class="test-section">
            <h3>ğŸ“¡ å¾Œç«¯é€£æ¥æ¸¬è©¦</h3>
            <button onclick="testBackendConnection()">æ¸¬è©¦å¾Œç«¯é€£æ¥</button>
            <div id="backend-status"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ¤ èªéŸ³ç”Ÿæˆæ¸¬è©¦</h3>
            <button onclick="generateTestVoice()">ç”Ÿæˆæ¸¬è©¦èªéŸ³</button>
            <div id="generation-status"></div>
            <div id="audio-info"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”Š éŸ³é »æ’­æ”¾æ¸¬è©¦</h3>
            <div id="audio-player-container"></div>
            <div class="controls">
                <button id="play-btn" onclick="togglePlayback()" disabled>â–¶ï¸ æ’­æ”¾</button>
                <button onclick="testDirectAccess()" disabled id="direct-btn">ğŸ”— ç›´æ¥è¨ªå•æ¸¬è©¦</button>
                <button onclick="downloadAudio()" disabled id="download-btn">ğŸ“¥ ä¸‹è¼‰æ¸¬è©¦</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="time-display">
                <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
            </div>
            <div id="playback-status"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ› ï¸ ç€è¦½å™¨å…¼å®¹æ€§æ¸¬è©¦</h3>
            <button onclick="testBrowserSupport()">æ¸¬è©¦ç€è¦½å™¨æ”¯æ´</button>
            <div id="browser-status"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ è¨ºæ–·æ—¥èªŒ</h3>
            <div id="debug-log" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px;"></div>
            <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
        </div>
    </div>

    <script>
        let audioElement = null;
        let currentAudioUrl = null;
        let debugLog = document.getElementById('debug-log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'color: red;' : 
                              type === 'success' ? 'color: green;' : 
                              type === 'warning' ? 'color: orange;' : 'color: black;';
            debugLog.innerHTML += `<div style="${colorClass}">[${timestamp}] ${message}</div>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[Audio Debug] ${message}`);
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

        async function testBackendConnection() {
            log('é–‹å§‹æ¸¬è©¦å¾Œç«¯é€£æ¥...', 'info');
            try {
                const response = await fetch('http://localhost:8001/health');
                if (response.ok) {
                    const data = await response.json();
                    showStatus('backend-status', `âœ… å¾Œç«¯é€£æ¥æˆåŠŸ: ${data.service}`, 'success');
                    log(`å¾Œç«¯æœå‹™æ­£å¸¸: ${data.service}`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showStatus('backend-status', `âŒ å¾Œç«¯é€£æ¥å¤±æ•—: ${error.message}`, 'error');
                log(`å¾Œç«¯é€£æ¥å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function generateTestVoice() {
            log('é–‹å§‹ç”Ÿæˆæ¸¬è©¦èªéŸ³...', 'info');
            showStatus('generation-status', 'ğŸ”„ æ­£åœ¨ç”ŸæˆèªéŸ³...', 'info');
            
            try {
                const response = await fetch('http://localhost:8001/api/v1/generate/voice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: 'é€™æ˜¯ä¸€å€‹éŸ³é »æ’­æ”¾æ¸¬è©¦ã€‚å¦‚æœä½ èƒ½è½åˆ°é€™æ®µè©±ï¼Œèªªæ˜èªéŸ³ç”Ÿæˆå’Œæ’­æ”¾éƒ½æ­£å¸¸å·¥ä½œã€‚',
                        voice: 'alloy',
                        speed: 1.0,
                        platform: 'youtube',
                        style: 'educational',
                        topic: 'éŸ³é »æ¸¬è©¦',
                        optimize_with_ai: true
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showStatus('generation-status', 'âœ… èªéŸ³ç”ŸæˆæˆåŠŸï¼', 'success');
                        
                        currentAudioUrl = data.data.url;
                        const audioInfo = `
                            <strong>èªéŸ³ä¿¡æ¯ï¼š</strong><br>
                            ğŸ”Š æä¾›è€…: ${data.data.provider}<br>
                            ğŸµ èªéŸ³: ${data.data.voice} @ ${data.data.speed}x<br>
                            â±ï¸ æ™‚é•·: ${data.data.duration} ç§’<br>
                            ğŸ“Š å“è³ª: ${data.data.quality}<br>
                            ğŸ”— URL: <a href="${data.data.url}" target="_blank">${data.data.url}</a><br>
                            ğŸ“ çœŸå¯¦æ–‡ä»¶: ${data.data.has_real_audio ? 'âœ… æ˜¯' : 'âŒ å¦'}
                        `;
                        showStatus('audio-info', audioInfo, 'success');
                        
                        // å•Ÿç”¨æ’­æ”¾æŒ‰éˆ•
                        document.getElementById('play-btn').disabled = false;
                        document.getElementById('direct-btn').disabled = false;
                        document.getElementById('download-btn').disabled = false;
                        
                        // å‰µå»ºéŸ³é »æ’­æ”¾å™¨
                        setupAudioPlayer(data.data.url);
                        
                        log(`èªéŸ³ç”ŸæˆæˆåŠŸ: ${data.data.provider}, URL: ${data.data.url}`, 'success');
                    } else {
                        throw new Error(data.error || 'èªéŸ³ç”Ÿæˆå¤±æ•—');
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
            } catch (error) {
                showStatus('generation-status', `âŒ èªéŸ³ç”Ÿæˆå¤±æ•—: ${error.message}`, 'error');
                log(`èªéŸ³ç”Ÿæˆå¤±æ•—: ${error.message}`, 'error');
            }
        }

        function setupAudioPlayer(url) {
            log(`è¨­ç½®éŸ³é »æ’­æ”¾å™¨: ${url}`, 'info');
            
            // ç§»é™¤èˆŠçš„æ’­æ”¾å™¨
            if (audioElement) {
                audioElement.pause();
                audioElement.remove();
            }

            // å‰µå»ºæ–°çš„éŸ³é »å…ƒç´ 
            audioElement = new Audio(url);
            audioElement.preload = 'metadata';
            audioElement.crossOrigin = 'anonymous';
            
            // äº‹ä»¶ç›£è½å™¨
            audioElement.addEventListener('loadstart', () => {
                log('é–‹å§‹è¼‰å…¥éŸ³é »æ–‡ä»¶...', 'info');
            });

            audioElement.addEventListener('loadedmetadata', () => {
                log(`éŸ³é »å…ƒæ•¸æ“šè¼‰å…¥å®Œæˆ: æ™‚é•· ${audioElement.duration.toFixed(1)} ç§’`, 'success');
                document.getElementById('total-time').textContent = formatTime(audioElement.duration);
            });

            audioElement.addEventListener('canplaythrough', () => {
                log('éŸ³é »æ–‡ä»¶å¯ä»¥å®Œæ•´æ’­æ”¾', 'success');
                showStatus('playback-status', 'âœ… éŸ³é »æ–‡ä»¶å·²å°±ç·’ï¼Œå¯ä»¥æ’­æ”¾', 'success');
            });

            audioElement.addEventListener('play', () => {
                log('éŸ³é »é–‹å§‹æ’­æ”¾', 'success');
                document.getElementById('play-btn').textContent = 'â¸ï¸ æš«åœ';
            });

            audioElement.addEventListener('pause', () => {
                log('éŸ³é »æš«åœæ’­æ”¾', 'info');
                document.getElementById('play-btn').textContent = 'â–¶ï¸ æ’­æ”¾';
            });

            audioElement.addEventListener('timeupdate', () => {
                const progress = (audioElement.currentTime / audioElement.duration) * 100;
                document.getElementById('progress-fill').style.width = progress + '%';
                document.getElementById('current-time').textContent = formatTime(audioElement.currentTime);
            });

            audioElement.addEventListener('ended', () => {
                log('éŸ³é »æ’­æ”¾çµæŸ', 'info');
                document.getElementById('play-btn').textContent = 'â–¶ï¸ æ’­æ”¾';
            });

            audioElement.addEventListener('error', (e) => {
                const errorCode = audioElement.error ? audioElement.error.code : 'unknown';
                const errorMsg = getAudioErrorMessage(errorCode);
                log(`éŸ³é »æ’­æ”¾éŒ¯èª¤: ${errorMsg} (code: ${errorCode})`, 'error');
                showStatus('playback-status', `âŒ éŸ³é »æ’­æ”¾éŒ¯èª¤: ${errorMsg}`, 'error');
            });

            // å°‡éŸ³é »å…ƒç´ åŠ å…¥DOMä»¥ä¾¿èª¿è©¦
            const container = document.getElementById('audio-player-container');
            container.innerHTML = '<p>HTML5 éŸ³é »æ’­æ”¾å™¨:</p>';
            container.appendChild(audioElement);
            audioElement.controls = true;
            audioElement.style.width = '100%';
        }

        function togglePlayback() {
            if (!audioElement) {
                log('éŸ³é »æ’­æ”¾å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }

            if (audioElement.paused) {
                log('å˜—è©¦æ’­æ”¾éŸ³é »...', 'info');
                audioElement.play().then(() => {
                    log('éŸ³é »æ’­æ”¾æˆåŠŸå•Ÿå‹•', 'success');
                }).catch(error => {
                    log(`éŸ³é »æ’­æ”¾å¤±æ•—: ${error.message}`, 'error');
                    showStatus('playback-status', `âŒ æ’­æ”¾å¤±æ•—: ${error.message}`, 'error');
                });
            } else {
                audioElement.pause();
                log('éŸ³é »å·²æš«åœ', 'info');
            }
        }

        async function testDirectAccess() {
            if (!currentAudioUrl) {
                log('æ²’æœ‰å¯ç”¨çš„éŸ³é »URL', 'error');
                return;
            }

            log(`æ¸¬è©¦ç›´æ¥è¨ªå•éŸ³é »æ–‡ä»¶: ${currentAudioUrl}`, 'info');
            
            try {
                const response = await fetch(currentAudioUrl, { method: 'HEAD' });
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    const contentLength = response.headers.get('content-length');
                    log(`ç›´æ¥è¨ªå•æˆåŠŸ: ${contentType}, ${contentLength} å­—ç¯€`, 'success');
                    showStatus('playback-status', `âœ… ç›´æ¥è¨ªå•æ¸¬è©¦æˆåŠŸ (${contentType}, ${contentLength} å­—ç¯€)`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`ç›´æ¥è¨ªå•å¤±æ•—: ${error.message}`, 'error');
                showStatus('playback-status', `âŒ ç›´æ¥è¨ªå•å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function downloadAudio() {
            if (!currentAudioUrl) {
                log('æ²’æœ‰å¯ç”¨çš„éŸ³é »URLé€²è¡Œä¸‹è¼‰', 'error');
                return;
            }

            log(`å˜—è©¦ä¸‹è¼‰éŸ³é »æ–‡ä»¶: ${currentAudioUrl}`, 'info');
            
            const link = document.createElement('a');
            link.href = currentAudioUrl;
            link.download = `test_audio_${Date.now()}.mp3`;
            link.style.display = 'none';
            document.body.appendChild(link);
            
            try {
                link.click();
                log('ä¸‹è¼‰å·²å•Ÿå‹•', 'success');
                showStatus('playback-status', 'âœ… ä¸‹è¼‰å·²å•Ÿå‹•', 'success');
            } catch (error) {
                log(`ä¸‹è¼‰å¤±æ•—: ${error.message}`, 'error');
                showStatus('playback-status', `âŒ ä¸‹è¼‰å¤±æ•—: ${error.message}`, 'error');
            } finally {
                document.body.removeChild(link);
            }
        }

        function testBrowserSupport() {
            log('æ¸¬è©¦ç€è¦½å™¨éŸ³é »æ”¯æ´...', 'info');
            
            const audio = document.createElement('audio');
            const tests = {
                'MP3': audio.canPlayType('audio/mpeg'),
                'MP4': audio.canPlayType('audio/mp4'),
                'OGG': audio.canPlayType('audio/ogg'),
                'WAV': audio.canPlayType('audio/wav'),
                'WebM': audio.canPlayType('audio/webm')
            };

            let supportInfo = '<strong>ç€è¦½å™¨éŸ³é »æ ¼å¼æ”¯æ´:</strong><br>';
            for (const [format, support] of Object.entries(tests)) {
                const level = support === 'probably' ? 'âœ… å®Œå…¨æ”¯æ´' :
                             support === 'maybe' ? 'âš ï¸ å¯èƒ½æ”¯æ´' : 'âŒ ä¸æ”¯æ´';
                supportInfo += `${format}: ${level}<br>`;
                log(`${format}: ${level} (${support})`, support ? 'success' : 'warning');
            }

            // æª¢æŸ¥ Web Audio API
            const hasWebAudio = !!(window.AudioContext || window.webkitAudioContext);
            supportInfo += `Web Audio API: ${hasWebAudio ? 'âœ… æ”¯æ´' : 'âŒ ä¸æ”¯æ´'}<br>`;
            log(`Web Audio API: ${hasWebAudio ? 'æ”¯æ´' : 'ä¸æ”¯æ´'}`, hasWebAudio ? 'success' : 'warning');

            // æª¢æŸ¥ç”¨æˆ¶åª’é«”æ¬Šé™
            supportInfo += `ç”¨æˆ¶ä»£ç†: ${navigator.userAgent.split(' ').slice(-2).join(' ')}<br>`;
            
            showStatus('browser-status', supportInfo, 'info');
        }

        function getAudioErrorMessage(code) {
            const errors = {
                1: 'MEDIA_ERR_ABORTED - éŸ³é »ä¸‹è¼‰è¢«ä¸­æ­¢',
                2: 'MEDIA_ERR_NETWORK - ç¶²è·¯éŒ¯èª¤',
                3: 'MEDIA_ERR_DECODE - éŸ³é »è§£ç¢¼éŒ¯èª¤',
                4: 'MEDIA_ERR_SRC_NOT_SUPPORTED - éŸ³é »æ ¼å¼ä¸æ”¯æ´'
            };
            return errors[code] || 'æœªçŸ¥éŒ¯èª¤';
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function clearLog() {
            debugLog.innerHTML = '';
            log('è¨ºæ–·æ—¥èªŒå·²æ¸…é™¤', 'info');
        }

        // åˆå§‹åŒ–
        log('éŸ³é »æ’­æ”¾è¨ºæ–·å·¥å…·å·²è¼‰å…¥', 'success');
        
        // è‡ªå‹•æ¸¬è©¦ç€è¦½å™¨æ”¯æ´
        setTimeout(testBrowserSupport, 1000);
    </script>
</body>
</html>