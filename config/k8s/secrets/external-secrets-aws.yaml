# =============================================================================
# ğŸ” AWS Secrets Manager æ•´åˆé…ç½® - External Secrets Operator
# =============================================================================
# 
# æ­¤é…ç½®ä½¿ç”¨ External Secrets Operator å¾ AWS Secrets Manager 
# è‡ªå‹•åŒæ­¥å¯†é‘°åˆ° Kubernetes Secrets
#
# å‰ç½®è¦æ±‚:
# 1. å®‰è£ External Secrets Operator
# 2. è¨­ç½® AWS IAM è§’è‰²å’Œæœå‹™å¸³æˆ¶ (IRSA)
# 3. åœ¨ AWS Secrets Manager ä¸­å‰µå»ºå°æ‡‰çš„å¯†é‘°
#
# å‰µå»ºæ—¥æœŸ: 2025-08-05
# ç¶­è­·è€…: DevOps & Security Team
# =============================================================================

# AWS IAM æœå‹™å¸³æˆ¶é…ç½®
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: autovideo-prod
  annotations:
    # AWS IAM Role ARN - æ›¿æ›ç‚ºå¯¦éš›çš„è§’è‰² ARN
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/AutoVideoExternalSecretsRole
---
# =============================================================================
# AWS Secrets Manager Secret Store é…ç½®
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: autovideo-prod
  labels:
    app: autovideo
    component: secret-management
    environment: production
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-west-2
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
---
# =============================================================================
# JWT å¯†é‘°åŒæ­¥ - å¾ AWS Secrets Manager
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: jwt-secrets-external
  namespace: autovideo-prod
  labels:
    app: autovideo
    component: auth
    environment: production
  annotations:
    external-secrets.io/description: "JWT RSA å¯†é‘°å°å¾ AWS Secrets Manager åŒæ­¥"
spec:
  # æ¯ 1 å°æ™‚åˆ·æ–°ä¸€æ¬¡
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: jwt-secrets-aws
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          managed-by: external-secrets
  data:
  - secretKey: jwt-private-key
    remoteRef:
      key: autovideo/prod/jwt-keys
      property: private-key
  - secretKey: jwt-public-key
    remoteRef:
      key: autovideo/prod/jwt-keys
      property: public-key
---
# =============================================================================
# è³‡æ–™åº«å¯†é‘°åŒæ­¥ - å¾ AWS Secrets Manager
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-secrets-external
  namespace: autovideo-prod
  labels:
    app: autovideo
    component: database
    environment: production
spec:
  refreshInterval: 30m
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: database-secrets-aws
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          managed-by: external-secrets
  data:
  - secretKey: postgres-password
    remoteRef:
      key: autovideo/prod/database
      property: postgres-password
  - secretKey: redis-password
    remoteRef:
      key: autovideo/prod/database
      property: redis-password
  - secretKey: postgres-url
    remoteRef:
      key: autovideo/prod/database
      property: postgres-url
  - secretKey: redis-url
    remoteRef:
      key: autovideo/prod/database
      property: redis-url
---
# =============================================================================
# AI API å¯†é‘°åŒæ­¥ - å¾ AWS Secrets Manager
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: ai-api-secrets-external
  namespace: autovideo-prod
  labels:
    app: autovideo
    component: ai-services
    environment: production
spec:
  refreshInterval: 2h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: ai-api-secrets-aws
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          managed-by: external-secrets
  data:
  # OpenAI å¯†é‘°
  - secretKey: openai-api-key
    remoteRef:
      key: autovideo/prod/ai-apis
      property: openai-api-key
  - secretKey: openai-org-id
    remoteRef:
      key: autovideo/prod/ai-apis
      property: openai-org-id
  # Google Gemini å¯†é‘°
  - secretKey: gemini-api-key
    remoteRef:
      key: autovideo/prod/ai-apis
      property: gemini-api-key
  - secretKey: gemini-project-id
    remoteRef:
      key: autovideo/prod/ai-apis
      property: gemini-project-id
  # Anthropic Claude å¯†é‘°
  - secretKey: anthropic-api-key
    remoteRef:
      key: autovideo/prod/ai-apis
      property: anthropic-api-key
  # Suno AI å¯†é‘°
  - secretKey: suno-api-key
    remoteRef:
      key: autovideo/prod/ai-apis
      property: suno-api-key
  # Stable Diffusion å¯†é‘°
  - secretKey: stable-diffusion-api-key
    remoteRef:
      key: autovideo/prod/ai-apis
      property: stable-diffusion-api-key
---
# =============================================================================
# æ”¯ä»˜æœå‹™å¯†é‘°åŒæ­¥ - å¾ AWS Secrets Manager
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: payment-secrets-external
  namespace: autovideo-prod
  labels:
    app: autovideo
    component: payment
    environment: production
spec:
  refreshInterval: 4h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: payment-secrets-aws
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          managed-by: external-secrets
  data:
  # Stripe å¯†é‘°
  - secretKey: stripe-publishable-key
    remoteRef:
      key: autovideo/prod/payment
      property: stripe-publishable-key
  - secretKey: stripe-secret-key
    remoteRef:
      key: autovideo/prod/payment
      property: stripe-secret-key
  - secretKey: stripe-webhook-secret
    remoteRef:
      key: autovideo/prod/payment
      property: stripe-webhook-secret
  # PayPal å¯†é‘°
  - secretKey: paypal-client-id
    remoteRef:
      key: autovideo/prod/payment
      property: paypal-client-id
  - secretKey: paypal-client-secret
    remoteRef:
      key: autovideo/prod/payment
      property: paypal-client-secret
---
# =============================================================================
# æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒå¯†é‘°åŒæ­¥ - å¾ AWS Secrets Manager
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: app-core-secrets-external
  namespace: autovideo-prod
  labels:
    app: autovideo
    component: core
    environment: production
spec:
  refreshInterval: 6h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: app-core-secrets-aws
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          managed-by: external-secrets
  data:
  - secretKey: app-secret-key
    remoteRef:
      key: autovideo/prod/app-core
      property: app-secret-key
  - secretKey: session-secret
    remoteRef:
      key: autovideo/prod/app-core
      property: session-secret
  - secretKey: encryption-key
    remoteRef:
      key: autovideo/prod/app-core
      property: encryption-key
  - secretKey: cookie-secret
    remoteRef:
      key: autovideo/prod/app-core
      property: cookie-secret
  - secretKey: csrf-secret
    remoteRef:
      key: autovideo/prod/app-core
      property: csrf-secret
---
# =============================================================================
# å¢é›†ç´šåˆ¥ Secret Store (ç”¨æ–¼å…±äº«å¯†é‘°)
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager-cluster
  labels:
    app: autovideo
    component: secret-management
    environment: production
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-west-2
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: autovideo-prod
---
# =============================================================================
# ç›£æ§å’Œæ—¥èªŒå¯†é‘°åŒæ­¥ - ä½¿ç”¨ ClusterSecretStore
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: monitoring-secrets-external
  namespace: autovideo-prod
  labels:
    app: autovideo
    component: monitoring
    environment: production
spec:
  refreshInterval: 8h
  secretStoreRef:
    name: aws-secrets-manager-cluster
    kind: ClusterSecretStore
  target:
    name: monitoring-secrets-aws
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          managed-by: external-secrets
  data:
  - secretKey: sentry-dsn
    remoteRef:
      key: autovideo/prod/monitoring
      property: sentry-dsn
  - secretKey: grafana-api-key
    remoteRef:
      key: autovideo/prod/monitoring
      property: grafana-api-key
  - secretKey: log-service-key
    remoteRef:
      key: autovideo/prod/monitoring
      property: log-service-key
---
# =============================================================================
# External Secrets ç›£æ§é…ç½®
# =============================================================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: external-secrets-monitor
  namespace: autovideo-prod
  labels:
    app: external-secrets
    environment: production
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: external-secrets
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
---
# =============================================================================
# External Secrets å‘Šè­¦è¦å‰‡
# =============================================================================
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: external-secrets-alerts
  namespace: autovideo-prod
  labels:
    app: external-secrets
    environment: production
spec:
  groups:
  - name: external-secrets
    rules:
    - alert: ExternalSecretSyncFailed
      expr: external_secrets_sync_calls_error_total > 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "External Secret åŒæ­¥å¤±æ•—"
        description: "Secret {{ $labels.name }} å¾ AWS Secrets Manager åŒæ­¥å¤±æ•—"
    
    - alert: ExternalSecretStale
      expr: (time() - external_secrets_sync_calls_total) > 7200
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "External Secret åŒæ­¥éæ™‚"
        description: "Secret {{ $labels.name }} è¶…é 2 å°æ™‚æœªåŒæ­¥"
    
    - alert: AWSSecretsManagerQuotaExceeded
      expr: external_secrets_aws_api_calls_total{status="quota_exceeded"} > 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "AWS Secrets Manager API é…é¡è¶…å‡º"
        description: "AWS Secrets Manager API èª¿ç”¨é…é¡å·²è¶…å‡ºé™åˆ¶"