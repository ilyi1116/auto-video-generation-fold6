# =============================================================================
# 🔐 AWS Secrets Manager 整合配置 - External Secrets Operator
# =============================================================================
# 
# 此配置使用 External Secrets Operator 從 AWS Secrets Manager 
# 自動同步密鑰到 Kubernetes Secrets
#
# 前置要求:
# 1. 安裝 External Secrets Operator
# 2. 設置 AWS IAM 角色和服務帳戶 (IRSA)
# 3. 在 AWS Secrets Manager 中創建對應的密鑰
#
# 創建日期: 2025-08-05
# 維護者: DevOps & Security Team
# =============================================================================

# AWS IAM 服務帳戶配置
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: autovideo-prod
  annotations:
    # AWS IAM Role ARN - 替換為實際的角色 ARN
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/AutoVideoExternalSecretsRole
---
# =============================================================================
# AWS Secrets Manager Secret Store 配置
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: autovideo-prod
  labels:
    app: autovideo
    component: secret-management
    environment: production
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-west-2
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
---
# =============================================================================
# JWT 密鑰同步 - 從 AWS Secrets Manager
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: jwt-secrets-external
  namespace: autovideo-prod
  labels:
    app: autovideo
    component: auth
    environment: production
  annotations:
    external-secrets.io/description: "JWT RSA 密鑰對從 AWS Secrets Manager 同步"
spec:
  # 每 1 小時刷新一次
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: jwt-secrets-aws
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          managed-by: external-secrets
  data:
  - secretKey: jwt-private-key
    remoteRef:
      key: autovideo/prod/jwt-keys
      property: private-key
  - secretKey: jwt-public-key
    remoteRef:
      key: autovideo/prod/jwt-keys
      property: public-key
---
# =============================================================================
# 資料庫密鑰同步 - 從 AWS Secrets Manager
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-secrets-external
  namespace: autovideo-prod
  labels:
    app: autovideo
    component: database
    environment: production
spec:
  refreshInterval: 30m
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: database-secrets-aws
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          managed-by: external-secrets
  data:
  - secretKey: postgres-password
    remoteRef:
      key: autovideo/prod/database
      property: postgres-password
  - secretKey: redis-password
    remoteRef:
      key: autovideo/prod/database
      property: redis-password
  - secretKey: postgres-url
    remoteRef:
      key: autovideo/prod/database
      property: postgres-url
  - secretKey: redis-url
    remoteRef:
      key: autovideo/prod/database
      property: redis-url
---
# =============================================================================
# AI API 密鑰同步 - 從 AWS Secrets Manager
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: ai-api-secrets-external
  namespace: autovideo-prod
  labels:
    app: autovideo
    component: ai-services
    environment: production
spec:
  refreshInterval: 2h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: ai-api-secrets-aws
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          managed-by: external-secrets
  data:
  # OpenAI 密鑰
  - secretKey: openai-api-key
    remoteRef:
      key: autovideo/prod/ai-apis
      property: openai-api-key
  - secretKey: openai-org-id
    remoteRef:
      key: autovideo/prod/ai-apis
      property: openai-org-id
  # Google Gemini 密鑰
  - secretKey: gemini-api-key
    remoteRef:
      key: autovideo/prod/ai-apis
      property: gemini-api-key
  - secretKey: gemini-project-id
    remoteRef:
      key: autovideo/prod/ai-apis
      property: gemini-project-id
  # Anthropic Claude 密鑰
  - secretKey: anthropic-api-key
    remoteRef:
      key: autovideo/prod/ai-apis
      property: anthropic-api-key
  # Suno AI 密鑰
  - secretKey: suno-api-key
    remoteRef:
      key: autovideo/prod/ai-apis
      property: suno-api-key
  # Stable Diffusion 密鑰
  - secretKey: stable-diffusion-api-key
    remoteRef:
      key: autovideo/prod/ai-apis
      property: stable-diffusion-api-key
---
# =============================================================================
# 支付服務密鑰同步 - 從 AWS Secrets Manager
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: payment-secrets-external
  namespace: autovideo-prod
  labels:
    app: autovideo
    component: payment
    environment: production
spec:
  refreshInterval: 4h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: payment-secrets-aws
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          managed-by: external-secrets
  data:
  # Stripe 密鑰
  - secretKey: stripe-publishable-key
    remoteRef:
      key: autovideo/prod/payment
      property: stripe-publishable-key
  - secretKey: stripe-secret-key
    remoteRef:
      key: autovideo/prod/payment
      property: stripe-secret-key
  - secretKey: stripe-webhook-secret
    remoteRef:
      key: autovideo/prod/payment
      property: stripe-webhook-secret
  # PayPal 密鑰
  - secretKey: paypal-client-id
    remoteRef:
      key: autovideo/prod/payment
      property: paypal-client-id
  - secretKey: paypal-client-secret
    remoteRef:
      key: autovideo/prod/payment
      property: paypal-client-secret
---
# =============================================================================
# 應用程式核心密鑰同步 - 從 AWS Secrets Manager
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: app-core-secrets-external
  namespace: autovideo-prod
  labels:
    app: autovideo
    component: core
    environment: production
spec:
  refreshInterval: 6h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: app-core-secrets-aws
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          managed-by: external-secrets
  data:
  - secretKey: app-secret-key
    remoteRef:
      key: autovideo/prod/app-core
      property: app-secret-key
  - secretKey: session-secret
    remoteRef:
      key: autovideo/prod/app-core
      property: session-secret
  - secretKey: encryption-key
    remoteRef:
      key: autovideo/prod/app-core
      property: encryption-key
  - secretKey: cookie-secret
    remoteRef:
      key: autovideo/prod/app-core
      property: cookie-secret
  - secretKey: csrf-secret
    remoteRef:
      key: autovideo/prod/app-core
      property: csrf-secret
---
# =============================================================================
# 叢集級別 Secret Store (用於共享密鑰)
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager-cluster
  labels:
    app: autovideo
    component: secret-management
    environment: production
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-west-2
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: autovideo-prod
---
# =============================================================================
# 監控和日誌密鑰同步 - 使用 ClusterSecretStore
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: monitoring-secrets-external
  namespace: autovideo-prod
  labels:
    app: autovideo
    component: monitoring
    environment: production
spec:
  refreshInterval: 8h
  secretStoreRef:
    name: aws-secrets-manager-cluster
    kind: ClusterSecretStore
  target:
    name: monitoring-secrets-aws
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          managed-by: external-secrets
  data:
  - secretKey: sentry-dsn
    remoteRef:
      key: autovideo/prod/monitoring
      property: sentry-dsn
  - secretKey: grafana-api-key
    remoteRef:
      key: autovideo/prod/monitoring
      property: grafana-api-key
  - secretKey: log-service-key
    remoteRef:
      key: autovideo/prod/monitoring
      property: log-service-key
---
# =============================================================================
# External Secrets 監控配置
# =============================================================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: external-secrets-monitor
  namespace: autovideo-prod
  labels:
    app: external-secrets
    environment: production
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: external-secrets
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
---
# =============================================================================
# External Secrets 告警規則
# =============================================================================
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: external-secrets-alerts
  namespace: autovideo-prod
  labels:
    app: external-secrets
    environment: production
spec:
  groups:
  - name: external-secrets
    rules:
    - alert: ExternalSecretSyncFailed
      expr: external_secrets_sync_calls_error_total > 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "External Secret 同步失敗"
        description: "Secret {{ $labels.name }} 從 AWS Secrets Manager 同步失敗"
    
    - alert: ExternalSecretStale
      expr: (time() - external_secrets_sync_calls_total) > 7200
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "External Secret 同步過時"
        description: "Secret {{ $labels.name }} 超過 2 小時未同步"
    
    - alert: AWSSecretsManagerQuotaExceeded
      expr: external_secrets_aws_api_calls_total{status="quota_exceeded"} > 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "AWS Secrets Manager API 配額超出"
        description: "AWS Secrets Manager API 調用配額已超出限制"