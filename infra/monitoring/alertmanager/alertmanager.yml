global:
  # SMTP é…ç½®
  smtp_smarthost: '${SMTP_SMARTHOST:-localhost:587}'
  smtp_from: 'alerts@auto-video-system.com'
  smtp_auth_username: '${SMTP_USERNAME:-alerts@auto-video-system.com}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true
  
  # Slack é…ç½®
  slack_api_url: '${SLACK_WEBHOOK_URL}'
  
  # è§£æè¶…æ™‚
  resolve_timeout: 5m

# è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'web.hook'
  routes:
    # é—œéµç³»çµ±å‘Šè­¦ - ç«‹å³é€šçŸ¥
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
    
    # å®‰å…¨ç›¸é—œå‘Šè­¦
    - match:
        alertname: SecurityAlert
      receiver: 'security-team'
      group_wait: 0s
      repeat_interval: 30m
    
    # æ•ˆèƒ½å‘Šè­¦
    - match:
        category: performance
      receiver: 'performance-team'
      group_wait: 2m
      repeat_interval: 1h
    
    # æ¥­å‹™æŒ‡æ¨™å‘Šè­¦
    - match:
        category: business
      receiver: 'product-team'
      group_wait: 5m
      repeat_interval: 4h

# æ¥æ”¶å™¨é…ç½®
receivers:
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://localhost:5001/webhook'
        send_resolved: true

  - name: 'critical-alerts'
    email_configs:
      - to: 'ops-team@auto-video-system.com'
        subject: 'ğŸš¨ CRITICAL: {{ .GroupLabels.alertname }} - {{ .GroupLabels.service }}'
        body: |
          âš ï¸ é—œéµç³»çµ±å‘Šè­¦

          å‘Šè­¦åç¨±: {{ .GroupLabels.alertname }}
          æœå‹™: {{ .GroupLabels.service }}
          é›†ç¾¤: {{ .GroupLabels.cluster }}
          åš´é‡ç¨‹åº¦: {{ .CommonLabels.severity }}

          è©³ç´°è³‡è¨Š:
          {{ range .Alerts }}
          - å¯¦ä¾‹: {{ .Labels.instance }}
          - æè¿°: {{ .Annotations.description }}
          - é–‹å§‹æ™‚é–“: {{ .StartsAt }}
          {{ end }}

          ç«‹å³è™•ç†: {{ .ExternalURL }}
        headers:
          Priority: 'high'
    
    webhook_configs:
      - url: 'http://slack-webhook-service:8080/critical'
        send_resolved: true
        title: 'ğŸš¨ Critical Alert'
        text: '{{ .CommonAnnotations.description }}'

  - name: 'security-team'
    email_configs:
      - to: 'security@auto-video-system.com'
        subject: 'ğŸ”’ Security Alert: {{ .GroupLabels.alertname }}'
        body: |
          ğŸ”’ å®‰å…¨å‘Šè­¦é€šçŸ¥

          å‘Šè­¦é¡å‹: {{ .GroupLabels.alertname }}
          å—å½±éŸ¿æœå‹™: {{ .GroupLabels.service }}
          æ™‚é–“: {{ .CommonAnnotations.timestamp }}

          å®‰å…¨äº‹ä»¶è©³æƒ…:
          {{ range .Alerts }}
          - ä¾†æº IP: {{ .Labels.source_ip }}
          - ç”¨æˆ¶: {{ .Labels.user_id }}
          - å‹•ä½œ: {{ .Labels.action }}
          - æè¿°: {{ .Annotations.description }}
          {{ end }}

          è«‹ç«‹å³æª¢æŸ¥ç³»çµ±å®‰å…¨ç‹€æ…‹ã€‚
    
    webhook_configs:
      - url: 'http://security-webhook:8080/alert'
        send_resolved: true

  - name: 'performance-team'
    email_configs:
      - to: 'performance@auto-video-system.com'
        subject: 'ğŸ“Š Performance Alert: {{ .GroupLabels.alertname }}'
        body: |
          ğŸ“Š æ•ˆèƒ½å‘Šè­¦é€šçŸ¥

          æœå‹™: {{ .GroupLabels.service }}
          æŒ‡æ¨™: {{ .GroupLabels.alertname }}
          
          æ•ˆèƒ½å•é¡Œ:
          {{ range .Alerts }}
          - å¯¦ä¾‹: {{ .Labels.instance }}
          - ç•¶å‰å€¼: {{ .Labels.value }}
          - é–¾å€¼: {{ .Labels.threshold }}
          - å½±éŸ¿: {{ .Annotations.impact }}
          {{ end }}

          å»ºè­°æª¢æŸ¥ç³»çµ±è³‡æºä½¿ç”¨æƒ…æ³ã€‚

  - name: 'product-team'
    email_configs:
      - to: 'product@auto-video-system.com'
        subject: 'ğŸ“ˆ Business Metrics Alert: {{ .GroupLabels.alertname }}'
        body: |
          ğŸ“ˆ æ¥­å‹™æŒ‡æ¨™å‘Šè­¦

          æ¥­å‹™æŒ‡æ¨™: {{ .GroupLabels.alertname }}
          å½±éŸ¿ç¯„åœ: {{ .GroupLabels.service }}
          
          æ¥­å‹™å½±éŸ¿åˆ†æ:
          {{ range .Alerts }}
          - æŒ‡æ¨™è®ŠåŒ–: {{ .Annotations.description }}
          - ç•¶å‰ç‹€æ…‹: {{ .Labels.status }}
          - å»ºè­°å‹•ä½œ: {{ .Annotations.recommendation }}
          {{ end }}

# æŠ‘åˆ¶è¦å‰‡
inhibit_rules:
  # æŠ‘åˆ¶ä½ç´šåˆ¥å‘Šè­¦å¦‚æœæœ‰ç›¸åŒæœå‹™çš„é«˜ç´šåˆ¥å‘Šè­¦
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service', 'instance']

  # æŠ‘åˆ¶ç›¸åŒå¯¦ä¾‹çš„é‡è¤‡å‘Šè­¦
  - source_match:
      alertname: 'InstanceDown'
    target_match_re:
      alertname: '.*'
    equal: ['instance']

  # æŠ‘åˆ¶ä¾è³´æœå‹™çš„å‘Šè­¦
  - source_match:
      alertname: 'DatabaseDown'
    target_match:
      category: 'database_dependent'
    equal: ['cluster']

# æ¨¡æ¿é…ç½®
templates:
  - '/etc/alertmanager/templates/*.tmpl'