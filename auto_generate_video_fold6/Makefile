# ====================================================================
# Auto Video ç³»çµ±é–‹ç™¼å·¥ä½œæµç¨‹è‡ªå‹•åŒ– Makefile
# ====================================================================

.PHONY: help install build test deploy clean dev prod

# é è¨­ç›®æ¨™
.DEFAULT_GOAL := help

# Colors for output
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m # No Color

# Project variables
PROJECT_NAME := auto-video
VERSION := 1.0.0
DOCKER_REGISTRY := auto-video
NAMESPACE := auto-video

help: ## ğŸ“– é¡¯ç¤ºæ‰€æœ‰å¯ç”¨çš„å‘½ä»¤
	@echo "$(GREEN)Auto Video System - Available Commands$(NC)"
	@echo "======================================"
	@awk 'BEGIN {FS = ":.*##"} /^[a-zA-Z_-]+:.*?##/ { printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2 }' $(MAKEFILE_LIST)
	@echo ""

# ================================
# Development Environment
# ================================

install: ## ğŸ“¦ å®‰è£æ‰€æœ‰ä¾è³´
	@echo "$(GREEN)Installing dependencies...$(NC)"
	@echo "Installing frontend dependencies..."
	cd frontend && npm install
	@echo "Installing Python dependencies..."
	pip install -r requirements.txt
	@echo "Installing development dependencies..."
	find services -name requirements-dev.txt -exec pip install -r {} \;
	@echo "$(GREEN)âœ… Dependencies installed successfully$(NC)"

setup: ## ğŸ”§ åˆå§‹åŒ–é–‹ç™¼ç’°å¢ƒ
	@echo "$(GREEN)Setting up development environment...$(NC)"
	@cp .env.example .env
	@echo "Generating SSL certificates..."
	@./security/ssl/generate-certs.sh
	@echo "Setting up pre-commit hooks..."
	@pre-commit install
	@echo "$(GREEN)âœ… Development environment ready$(NC)"

# ================================
# Code Quality
# ================================

lint: ## ğŸ” åŸ·è¡Œç¨‹å¼ç¢¼æª¢æŸ¥
	@echo "$(GREEN)Running linters...$(NC)"
	@echo "Linting Python code..."
	@ruff check services/
	@flake8 services/
	@mypy services/
	@echo "Linting frontend code..."
	@cd frontend && npm run lint
	@echo "$(GREEN)âœ… All linting checks passed$(NC)"

format: ## ğŸ¨ æ ¼å¼åŒ–ç¨‹å¼ç¢¼
	@echo "$(GREEN)Formatting code...$(NC)"
	@echo "Formatting Python code..."
	@black services/
	@isort services/
	@ruff --fix services/
	@echo "Formatting frontend code..."
	@cd frontend && npm run format
	@echo "$(GREEN)âœ… Code formatted successfully$(NC)"

# ================================
# Testing
# ================================

test: ## ğŸ§ª åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
	@echo "$(GREEN)Running tests...$(NC)"
	@echo "Running Python tests..."
	@pytest services/ --cov=. --cov-report=html --cov-report=term
	@echo "Running frontend tests..."
	@cd frontend && npm test
	@echo "$(GREEN)âœ… All tests passed$(NC)"

test-unit: ## ğŸ”¬ åŸ·è¡Œå–®å…ƒæ¸¬è©¦
	@echo "$(GREEN)Running unit tests...$(NC)"
	@pytest services/ -m "not integration"
	@cd frontend && npm run test:unit

test-integration: ## ğŸ”— åŸ·è¡Œæ•´åˆæ¸¬è©¦
	@echo "$(GREEN)Running integration tests...$(NC)"
	@pytest services/ -m integration
	@cd frontend && npm run test:integration

test-e2e: ## ğŸ­ åŸ·è¡Œç«¯å°ç«¯æ¸¬è©¦
	@echo "$(GREEN)Running E2E tests...$(NC)"
	@cd frontend && npm run test:e2e

coverage: ## ğŸ“Š ç”Ÿæˆæ¸¬è©¦è¦†è“‹ç‡å ±å‘Š
	@echo "$(GREEN)Generating coverage report...$(NC)"
	@pytest services/ --cov=. --cov-report=html
	@cd frontend && npm run test:coverage
	@echo "$(GREEN)ğŸ“Š Coverage report generated$(NC)"

# ================================
# Docker Operations
# ================================

docker-build: ## ğŸ³ æ§‹å»ºæ‰€æœ‰ Docker æ˜ åƒ
	@echo "$(GREEN)Building Docker images...$(NC)"
	@docker-compose build
	@echo "$(GREEN)âœ… Docker images built successfully$(NC)"

docker-build-prod: ## ğŸš€ æ§‹å»ºç”Ÿç”¢ç’°å¢ƒ Docker æ˜ åƒ
	@echo "$(GREEN)Building production Docker images...$(NC)"
	@docker-compose -f docker-compose.prod.yml build
	@echo "$(GREEN)âœ… Production images built successfully$(NC)"

docker-up: ## â¬†ï¸ å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ
	@echo "$(GREEN)Starting development environment...$(NC)"
	@docker-compose -f docker-compose.dev.yml up -d
	@echo "$(GREEN)âœ… Development environment started$(NC)"
	@echo "Frontend: http://localhost:3000"
	@echo "API: http://localhost:8000"
	@echo "Grafana: http://localhost:3001"

docker-up-prod: ## ğŸŒŸ å•Ÿå‹•ç”Ÿç”¢ç’°å¢ƒ
	@echo "$(GREEN)Starting production environment...$(NC)"
	@docker-compose -f docker-compose.prod.yml up -d
	@echo "$(GREEN)âœ… Production environment started$(NC)"

docker-down: ## â¬‡ï¸ åœæ­¢ Docker ç’°å¢ƒ
	@echo "$(YELLOW)Stopping Docker environment...$(NC)"
	@docker-compose down
	@docker-compose -f docker-compose.dev.yml down
	@docker-compose -f docker-compose.prod.yml down
	@echo "$(GREEN)âœ… Docker environment stopped$(NC)"

docker-logs: ## ğŸ“‹ æŸ¥çœ‹ Docker æ—¥èªŒ
	@docker-compose logs -f

docker-clean: ## ğŸ§¹ æ¸…ç† Docker è³‡æº
	@echo "$(YELLOW)Cleaning Docker resources...$(NC)"
	@docker system prune -f
	@docker volume prune -f
	@echo "$(GREEN)âœ… Docker resources cleaned$(NC)"

# ================================
# Monitoring
# ================================

monitoring-up: ## ğŸ“Š å•Ÿå‹•ç›£æ§ç³»çµ±
	@echo "$(GREEN)Starting monitoring system...$(NC)"
	@./scripts/start-monitoring.sh
	@echo "$(GREEN)âœ… Monitoring system started$(NC)"

monitoring-down: ## ğŸ“‰ åœæ­¢ç›£æ§ç³»çµ±
	@echo "$(YELLOW)Stopping monitoring system...$(NC)"
	@./scripts/stop-monitoring.sh
	@echo "$(GREEN)âœ… Monitoring system stopped$(NC)"

# ================================
# Database Operations
# ================================

db-migrate: ## ğŸ—ƒï¸ åŸ·è¡Œè³‡æ–™åº«é·ç§»
	@echo "$(GREEN)Running database migrations...$(NC)"
	@docker-compose exec api-gateway alembic upgrade head
	@echo "$(GREEN)âœ… Database migrations completed$(NC)"

db-reset: ## ğŸ”„ é‡ç½®è³‡æ–™åº«
	@echo "$(YELLOW)Resetting database...$(NC)"
	@docker-compose down
	@docker volume rm auto_generate_video_fold6_postgres_data
	@docker-compose up -d postgres
	@sleep 10
	@make db-migrate
	@echo "$(GREEN)âœ… Database reset completed$(NC)"

db-backup: ## ğŸ’¾ å‚™ä»½è³‡æ–™åº«
	@echo "$(GREEN)Creating database backup...$(NC)"
	@./scripts/backup-system.sh
	@echo "$(GREEN)âœ… Database backup completed$(NC)"

db-restore: ## ğŸ”„ é‚„åŸè³‡æ–™åº«
	@echo "$(GREEN)Restoring database from backup...$(NC)"
	@if [ -z "$(BACKUP_ID)" ]; then \
		echo "$(RED)âŒ Please specify BACKUP_ID: make db-restore BACKUP_ID=20250126_120000$(NC)"; \
		exit 1; \
	fi
	@./scripts/restore-system.sh $(BACKUP_ID)
	@echo "$(GREEN)âœ… Database restored successfully$(NC)"

# ================================
# Kubernetes Deployment
# ================================

k8s-apply: ## â˜¸ï¸ éƒ¨ç½²åˆ° Kubernetes
	@echo "$(GREEN)Deploying to Kubernetes...$(NC)"
	@kubectl apply -f k8s/namespace.yaml
	@kubectl apply -f k8s/configmap.yaml
	@kubectl apply -f k8s/secrets.yaml
	@kubectl apply -f k8s/deployments.yaml
	@kubectl apply -f k8s/services.yaml
	@kubectl apply -f k8s/ingress.yaml
	@kubectl apply -f k8s/hpa.yaml
	@echo "$(GREEN)âœ… Deployed to Kubernetes$(NC)"

k8s-delete: ## ğŸ—‘ï¸ å¾ Kubernetes åˆªé™¤
	@echo "$(YELLOW)Deleting from Kubernetes...$(NC)"
	@kubectl delete -f k8s/ --ignore-not-found=true
	@echo "$(GREEN)âœ… Deleted from Kubernetes$(NC)"

k8s-status: ## ğŸ“‹ æŸ¥çœ‹ Kubernetes ç‹€æ…‹
	@echo "$(GREEN)Kubernetes Status:$(NC)"
	@kubectl get pods -n $(NAMESPACE)
	@kubectl get services -n $(NAMESPACE)
	@kubectl get ingress -n $(NAMESPACE)

k8s-logs: ## ğŸ“– æŸ¥çœ‹ Kubernetes æ—¥èªŒ
	@kubectl logs -f deployment/api-gateway -n $(NAMESPACE)

# ================================
# Performance & Security
# ================================

benchmark: ## âš¡ åŸ·è¡Œæ•ˆèƒ½åŸºæº–æ¸¬è©¦
	@echo "$(GREEN)Running performance benchmarks...$(NC)"
	@python performance/benchmarking/performance-tests.py
	@echo "$(GREEN)âœ… Benchmarks completed$(NC)"

security-scan: ## ğŸ”’ åŸ·è¡Œå®‰å…¨æƒæ
	@echo "$(GREEN)Running security scans...$(NC)"
	@echo "Scanning Python code..."
	@bandit -r services/ -f json -o bandit-report.json
	@echo "Scanning Python dependencies..."
	@safety check
	@echo "Scanning frontend dependencies..."
	@cd frontend && npm audit --audit-level=high
	@echo "Scanning Docker images..."
	@docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
		aquasec/trivy image $(DOCKER_REGISTRY)/api-gateway:latest
	@echo "$(GREEN)âœ… Security scans completed$(NC)"

# ================================
# Release Management
# ================================

build: ## ğŸ—ï¸ æ§‹å»ºæ‰€æœ‰çµ„ä»¶
	@echo "$(GREEN)Building all components...$(NC)"
	@make docker-build
	@cd frontend && npm run build
	@echo "$(GREEN)âœ… Build completed$(NC)"

release: ## ğŸš€ å‰µå»ºç™¼å¸ƒç‰ˆæœ¬
	@echo "$(GREEN)Creating release $(VERSION)...$(NC)"
	@make lint
	@make test
	@make build
	@git tag -a v$(VERSION) -m "Release version $(VERSION)"
	@echo "$(GREEN)âœ… Release $(VERSION) created$(NC)"

deploy-staging: ## ğŸ­ éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
	@echo "$(GREEN)Deploying to staging...$(NC)"
	@docker-compose -f docker-compose.staging.yml up -d
	@echo "$(GREEN)âœ… Deployed to staging$(NC)"

deploy-production: ## ğŸŒŸ éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
	@echo "$(GREEN)Deploying to production...$(NC)"
	@make k8s-apply
	@echo "$(GREEN)âœ… Deployed to production$(NC)"

# ================================
# Utilities
# ================================

clean: ## ğŸ§¹ æ¸…ç†æ‰€æœ‰ç”Ÿæˆæª”æ¡ˆ
	@echo "$(YELLOW)Cleaning up...$(NC)"
	@find . -type f -name "*.pyc" -delete
	@find . -type d -name "__pycache__" -delete
	@find . -type d -name "*.egg-info" -exec rm -rf {} +
	@rm -rf .coverage htmlcov/ .pytest_cache/
	@cd frontend && npm run clean
	@echo "$(GREEN)âœ… Cleanup completed$(NC)"

health-check: ## ğŸ¥ åŸ·è¡Œç³»çµ±å¥åº·æª¢æŸ¥
	@echo "$(GREEN)Running health checks...$(NC)"
	@./scripts/health-check.sh
	@echo "$(GREEN)âœ… Health checks completed$(NC)"

logs: ## ğŸ“‹ æŸ¥çœ‹ç³»çµ±æ—¥èªŒ
	@echo "$(GREEN)Displaying system logs...$(NC)"
	@docker-compose logs -f --tail=100

shell: ## ğŸš é€²å…¥é–‹ç™¼å®¹å™¨ Shell
	@docker-compose exec api-gateway /bin/bash

# ================================
# Documentation
# ================================

docs: ## ğŸ“š ç”Ÿæˆæ–‡æª”
	@echo "$(GREEN)Generating documentation...$(NC)"
	@cd frontend && npm run build-storybook
	@swagger-codegen generate -i docs/api/openapi.yaml -l html2 -o docs/api/html/
	@echo "$(GREEN)âœ… Documentation generated$(NC)"

docs-serve: ## ğŸŒ å•Ÿå‹•æ–‡æª”æœå‹™å™¨
	@echo "$(GREEN)Starting documentation server...$(NC)"
	@cd docs && python -m http.server 8080

# ================================
# Development Helpers
# ================================

install-tools: ## ğŸ› ï¸ å®‰è£é–‹ç™¼å·¥å…·
	@echo "$(GREEN)Installing development tools...$(NC)"
	@pip install black isort flake8 pytest safety
	@npm install -g @commitlint/cli @commitlint/config-conventional
	@echo "$(GREEN)âœ… Development tools installed$(NC)"

update-deps: ## ğŸ“¦ æ›´æ–°ä¾è³´åŒ…
	@echo "$(GREEN)Updating dependencies...$(NC)"
	@cd frontend && npm update
	@pip-review --local --auto
	@echo "$(GREEN)âœ… Dependencies updated$(NC)"

git-hooks: ## ğŸª å®‰è£ Git hooks
	@echo "$(GREEN)Installing Git hooks...$(NC)"
	@pre-commit install
	@echo "$(GREEN)âœ… Git hooks installed$(NC)"

# ================================
# Environment Management
# ================================

env-check: ## âœ… æª¢æŸ¥ç’°å¢ƒè¨­å®š
	@echo "$(GREEN)Checking environment...$(NC)"
	@echo "Docker version: $$(docker --version)"
	@echo "Docker Compose version: $$(docker-compose --version)"
	@echo "Node.js version: $$(node --version)"
	@echo "Python version: $$(python --version)"
	@echo "$(GREEN)âœ… Environment check completed$(NC)"

env-copy: ## ğŸ“‹ è¤‡è£½ç’°å¢ƒè¨­å®šæª”æ¡ˆ
	@if [ ! -f .env ]; then \
		echo "$(GREEN)Copying .env.example to .env...$(NC)"; \
		cp .env.example .env; \
		echo "$(YELLOW)âš ï¸  Please edit .env with your configuration$(NC)"; \
	else \
		echo "$(YELLOW).env file already exists$(NC)"; \
	fi

# Help with colored output
info: ## â„¹ï¸ é¡¯ç¤ºå°ˆæ¡ˆè³‡è¨Š
	@echo "$(GREEN)Auto Video System$(NC)"
	@echo "ç‰ˆæœ¬: $(VERSION)"
	@echo "å°ˆæ¡ˆåç¨±: $(PROJECT_NAME)"
	@echo "å‘½åç©ºé–“: $(NAMESPACE)"
	@echo ""
	@echo "$(YELLOW)Quick Start:$(NC)"
	@echo "  1. make setup"
	@echo "  2. make docker-up"
	@echo "  3. make health-check"
	@echo ""
	@echo "$(YELLOW)Useful Commands:$(NC)"
	@echo "  make test          # åŸ·è¡Œæ¸¬è©¦"
	@echo "  make lint          # ç¨‹å¼ç¢¼æª¢æŸ¥"
	@echo "  make docker-logs   # æŸ¥çœ‹æ—¥èªŒ"
	@echo "  make monitoring-up # å•Ÿå‹•ç›£æ§"