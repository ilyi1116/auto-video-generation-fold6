name: å¾Œç«¯æœå‹™å“è³ªæª¢æŸ¥

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'services/**'
      - 'pyproject.toml'
      - '.github/workflows/backend-quality.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'services/**'
      - 'pyproject.toml'
      - '.github/workflows/backend-quality.yml'

env:
  PYTHON_VERSION: "3.11"

jobs:
  code-quality:
    name: å¾Œç«¯ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [
          "auth-service",
          "ai-service", 
          "video-service",
          "data-service",
          "storage-service",
          "social-service",
          "trend-service",
          "scheduler-service",
          "inference-service"
        ]
    
    steps:
    - name: Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: è¨­ç½® Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: å®‰è£ç³»çµ±ä¾è³´
      run: |
        sudo apt-get update
        sudo apt-get install -y redis-server postgresql-client

    - name: å®‰è£ Python ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,test]"

    - name: å®‰è£æœå‹™ç‰¹å®šä¾è³´
      working-directory: ./services/${{ matrix.service }}
      run: |
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        if [ -f requirements-dev.txt ]; then
          pip install -r requirements-dev.txt
        fi

    - name: ç¨‹å¼ç¢¼æ ¼å¼æª¢æŸ¥ (Black)
      working-directory: ./services/${{ matrix.service }}
      run: |
        black --check --diff .

    - name: å°å…¥æ’åºæª¢æŸ¥ (isort)
      working-directory: ./services/${{ matrix.service }}
      run: |
        isort --check-only --diff .

    - name: ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥ (Ruff)
      working-directory: ./services/${{ matrix.service }}
      run: |
        ruff check .

    - name: ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥ (Flake8)
      working-directory: ./services/${{ matrix.service }}
      run: |
        flake8 .

    - name: é¡å‹æª¢æŸ¥ (MyPy)
      working-directory: ./services/${{ matrix.service }}
      run: |
        mypy .
      continue-on-error: true  # MyPy å¯èƒ½éœ€è¦é¡å¤–é…ç½®

    - name: å®‰å…¨æ€§æª¢æŸ¥ (Bandit)
      working-directory: ./services/${{ matrix.service }}
      run: |
        bandit -r . -f json -o bandit-report.json || true
        if [ -f bandit-report.json ]; then
          echo "Bandit å®‰å…¨æƒæå®Œæˆ"
          cat bandit-report.json
        fi

    - name: ä¸Šå‚³ Bandit å ±å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: bandit-report-${{ matrix.service }}
        path: services/${{ matrix.service }}/bandit-report.json
        retention-days: 7

  unit-tests:
    name: å¾Œç«¯å–®å…ƒæ¸¬è©¦
    runs-on: ubuntu-latest
    needs: code-quality
    
    strategy:
      matrix:
        service: [
          "auth-service",
          "ai-service", 
          "video-service",
          "data-service",
          "storage-service",
          "social-service",
          "trend-service",
          "scheduler-service",
          "inference-service"
        ]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: è¨­ç½® Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: å®‰è£ Python ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,test]"

    - name: å®‰è£æœå‹™ç‰¹å®šä¾è³´
      working-directory: ./services/${{ matrix.service }}
      run: |
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        if [ -f requirements-dev.txt ]; then
          pip install -r requirements-dev.txt
        fi

    - name: è¨­ç½®æ¸¬è©¦ç’°å¢ƒè®Šæ•¸
      run: |
        echo "TESTING=true" >> $GITHUB_ENV
        echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/test_db" >> $GITHUB_ENV
        echo "REDIS_URL=redis://localhost:6379/1" >> $GITHUB_ENV
        echo "JWT_SECRET=test-secret-key-for-testing-only" >> $GITHUB_ENV
        echo "AWS_ACCESS_KEY_ID=test" >> $GITHUB_ENV
        echo "AWS_SECRET_ACCESS_KEY=test" >> $GITHUB_ENV
        echo "DISABLE_EXTERNAL_APIS=true" >> $GITHUB_ENV

    - name: åŸ·è¡Œå–®å…ƒæ¸¬è©¦
      working-directory: ./services/${{ matrix.service }}
      run: |
        if [ -d tests ]; then
          pytest tests/ \
            --cov=. \
            --cov-report=html:htmlcov \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --cov-fail-under=70 \
            --junit-xml=pytest-results.xml \
            -v
        else
          echo "æ²’æœ‰æ‰¾åˆ°æ¸¬è©¦ç›®éŒ„ï¼Œè·³éæ¸¬è©¦"
        fi

    - name: ä¸Šå‚³æ¸¬è©¦è¦†è“‹ç‡åˆ° Codecov
      uses: codecov/codecov-action@v3
      if: always()
      with:
        file: ./services/${{ matrix.service }}/coverage.xml
        flags: backend,${{ matrix.service }}
        name: ${{ matrix.service }}-coverage
        fail_ci_if_error: false

    - name: ä¸Šå‚³æ¸¬è©¦çµæœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.service }}
        path: |
          services/${{ matrix.service }}/htmlcov/
          services/${{ matrix.service }}/pytest-results.xml
          services/${{ matrix.service }}/coverage.xml
        retention-days: 7

  integration-tests:
    name: å¾Œç«¯æ•´åˆæ¸¬è©¦
    runs-on: ubuntu-latest
    needs: unit-tests
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: è¨­ç½® Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: å®‰è£ç³»çµ±ä¾è³´
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client

    - name: å®‰è£ Python ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,test]"

    - name: å®‰è£æ‰€æœ‰æœå‹™ä¾è³´
      run: |
        for service in services/*/; do
          if [ -f "$service/requirements.txt" ]; then
            pip install -r "$service/requirements.txt"
          fi
          if [ -f "$service/requirements-dev.txt" ]; then
            pip install -r "$service/requirements-dev.txt"
          fi
        done

    - name: è¨­ç½®æ¸¬è©¦ç’°å¢ƒè®Šæ•¸
      run: |
        echo "TESTING=true" >> $GITHUB_ENV
        echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/test_db" >> $GITHUB_ENV
        echo "REDIS_URL=redis://localhost:6379/1" >> $GITHUB_ENV
        echo "JWT_SECRET=test-secret-key-for-testing-only" >> $GITHUB_ENV
        echo "DISABLE_EXTERNAL_APIS=true" >> $GITHUB_ENV

    - name: è¨­ç½®æ¸¬è©¦è³‡æ–™åº«
      run: |
        PGPASSWORD=postgres psql -h localhost -U postgres -d test_db -c "CREATE EXTENSION IF NOT EXISTS uuid-ossp;"

    - name: åŸ·è¡Œæ•´åˆæ¸¬è©¦
      run: |
        pytest services/ \
          -m integration \
          --cov=services \
          --cov-report=html:htmlcov-integration \
          --cov-report=xml:coverage-integration.xml \
          --junit-xml=pytest-integration-results.xml \
          -v

    - name: ä¸Šå‚³æ•´åˆæ¸¬è©¦è¦†è“‹ç‡
      uses: codecov/codecov-action@v3
      if: always()
      with:
        file: ./coverage-integration.xml
        flags: backend,integration
        name: integration-coverage
        fail_ci_if_error: false

    - name: ä¸Šå‚³æ•´åˆæ¸¬è©¦çµæœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-results
        path: |
          htmlcov-integration/
          pytest-integration-results.xml
          coverage-integration.xml
        retention-days: 7

  security-scan:
    name: å¾Œç«¯å®‰å…¨æƒæ
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: è¨­ç½® Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: å®‰è£å®‰å…¨æƒæå·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit semgrep

    - name: åŸ·è¡Œä¾è³´å®‰å…¨æƒæ (Safety)
      run: |
        # æƒæä¸»è¦ä¾è³´
        safety check --json --output safety-report.json || true
        
        # æƒæå„æœå‹™ä¾è³´
        for service in services/*/; do
          if [ -f "$service/requirements.txt" ]; then
            echo "æƒæ $service ä¾è³´..."
            safety check -r "$service/requirements.txt" --json --output "safety-report-$(basename $service).json" || true
          fi
        done

    - name: åŸ·è¡Œç¨‹å¼ç¢¼å®‰å…¨æƒæ (Bandit)
      run: |
        bandit -r services/ -f json -o bandit-security-report.json || true

    - name: åŸ·è¡Œé«˜ç´šå®‰å…¨æƒæ (Semgrep)
      run: |
        semgrep --config=auto services/ --json --output=semgrep-report.json || true

    - name: ä¸Šå‚³å®‰å…¨æƒæå ±å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          safety-report*.json
          bandit-security-report.json
          semgrep-report.json
        retention-days: 30

  quality-gate:
    name: å¾Œç«¯å“è³ªé–˜é“
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, integration-tests, security-scan]
    if: always()
    
    steps:
    - name: æª¢æŸ¥æ‰€æœ‰ä½œæ¥­ç‹€æ…‹
      run: |
        echo "ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥: ${{ needs.code-quality.result }}"
        echo "å–®å…ƒæ¸¬è©¦: ${{ needs.unit-tests.result }}"
        echo "æ•´åˆæ¸¬è©¦: ${{ needs.integration-tests.result }}"
        echo "å®‰å…¨æƒæ: ${{ needs.security-scan.result }}"
        
        if [ "${{ needs.code-quality.result }}" != "success" ] || \
           [ "${{ needs.unit-tests.result }}" != "success" ] || \
           [ "${{ needs.integration-tests.result }}" != "success" ] || \
           [ "${{ needs.security-scan.result }}" != "success" ]; then
          echo "âŒ å¾Œç«¯å“è³ªé–˜é“æª¢æŸ¥å¤±æ•—"
          exit 1
        else
          echo "âœ… æ‰€æœ‰å¾Œç«¯å“è³ªæª¢æŸ¥é€šé"
        fi

    - name: è©•è«– PR çµæœ
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const { owner, repo, number } = context.issue;
          const results = {
            'code-quality': '${{ needs.code-quality.result }}',
            'unit-tests': '${{ needs.unit-tests.result }}',
            'integration-tests': '${{ needs.integration-tests.result }}',
            'security-scan': '${{ needs.security-scan.result }}'
          };
          
          const passed = Object.values(results).every(r => r === 'success');
          const emoji = passed ? 'âœ…' : 'âŒ';
          const status = passed ? 'é€šé' : 'å¤±æ•—';
          
          const comment = `
          ## ${emoji} å¾Œç«¯å“è³ªæª¢æŸ¥çµæœï¼š${status}
          
          | æª¢æŸ¥é …ç›® | ç‹€æ…‹ |
          |---------|------|
          | ç¨‹å¼ç¢¼å“è³ª | ${results['code-quality'] === 'success' ? 'âœ…' : 'âŒ'} |
          | å–®å…ƒæ¸¬è©¦ | ${results['unit-tests'] === 'success' ? 'âœ…' : 'âŒ'} |
          | æ•´åˆæ¸¬è©¦ | ${results['integration-tests'] === 'success' ? 'âœ…' : 'âŒ'} |
          | å®‰å…¨æƒæ | ${results['security-scan'] === 'success' ? 'âœ…' : 'âŒ'} |
          
          ${passed ? 'ğŸ‰ æ‰€æœ‰å¾Œç«¯æª¢æŸ¥éƒ½é€šéäº†ï¼å¯ä»¥é€²è¡Œåˆä½µã€‚' : 'âš ï¸ è«‹ä¿®å¾©å¤±æ•—çš„æª¢æŸ¥é …ç›®å¾Œå†é€²è¡Œåˆä½µã€‚'}
          `;
          
          github.rest.issues.createComment({
            owner,
            repo,
            issue_number: number,
            body: comment
          });