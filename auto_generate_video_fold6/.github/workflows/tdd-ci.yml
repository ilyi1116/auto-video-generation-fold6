# TDD CI/CD ç®¡é“
# å°ˆç‚º Test-Driven Development å·¥ä½œæµç¨‹è¨­è¨ˆçš„æŒçºŒæ•´åˆç®¡é“

name: TDD CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/*, red/*, green/*, refactor/* ]
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  # TDD ç’°å¢ƒè®Šæ•¸
  TDD_COVERAGE_THRESHOLD: 90
  TDD_COMPLEXITY_LIMIT: 10
  TDD_TEST_TIMEOUT: 600

jobs:
  # TDD æµç¨‹æª¢æŸ¥
  tdd-validation:
    name: TDD Flow Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # éœ€è¦æ¯”è¼ƒå‰ä¸€å€‹æäº¤
      
      - name: Validate TDD commit message
        run: |
          echo "ğŸ§¬ é©—è­‰ TDD æäº¤è¨Šæ¯æ ¼å¼..."
          
          # å–å¾—æœ€æ–°æäº¤è¨Šæ¯
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          echo "æäº¤è¨Šæ¯: $COMMIT_MSG"
          
          # æª¢æŸ¥ TDD å‰ç¶´
          if [[ "$COMMIT_MSG" =~ ^(red|green|refactor|test|feat|fix|docs):.* ]]; then
            echo "âœ… TDD æäº¤è¨Šæ¯æ ¼å¼æ­£ç¢º"
            
            # æ ¹æ“šä¸åŒå‰ç¶´è¨­å®šå¾ŒçºŒæª¢æŸ¥
            if [[ "$COMMIT_MSG" =~ ^red:.* ]]; then
              echo "RED_PHASE=true" >> $GITHUB_ENV
              echo "ğŸ“ RED éšæ®µæäº¤ - é æœŸæœƒæœ‰å¤±æ•—æ¸¬è©¦"
            elif [[ "$COMMIT_MSG" =~ ^green:.* ]]; then
              echo "GREEN_PHASE=true" >> $GITHUB_ENV
              echo "ğŸ“ GREEN éšæ®µæäº¤ - æ‰€æœ‰æ¸¬è©¦æ‡‰è©²é€šé"
            elif [[ "$COMMIT_MSG" =~ ^refactor:.* ]]; then
              echo "REFACTOR_PHASE=true" >> $GITHUB_ENV
              echo "ğŸ“ REFACTOR éšæ®µæäº¤ - åŠŸèƒ½ä¸è®Šï¼Œæ”¹å–„ç¨‹å¼ç¢¼çµæ§‹"
            fi
          else
            echo "âš ï¸ æäº¤è¨Šæ¯ä¸ç¬¦åˆ TDD æ ¼å¼ï¼Œä½†å…è¨±ç¹¼çºŒ"
            echo "å»ºè­°ä½¿ç”¨: red:, green:, refactor:, test:, feat:, fix:, docs: å‰ç¶´"
          fi
      
      - name: Analyze changed files
        run: |
          echo "ğŸ” åˆ†æç•°å‹•æª”æ¡ˆ..."
          
          # æª¢æŸ¥ç•°å‹•çš„æª”æ¡ˆé¡å‹
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || echo "")
          echo "ç•°å‹•æª”æ¡ˆ:"
          echo "$CHANGED_FILES"
          
          # åˆ†ææª”æ¡ˆé¡å‹
          TEST_FILES=$(echo "$CHANGED_FILES" | grep -E "\.(test|spec)\.(js|ts|py)$" || echo "")
          SOURCE_FILES=$(echo "$CHANGED_FILES" | grep -E "\.(js|ts|py|svelte)$" | grep -v -E "\.(test|spec)\." || echo "")
          
          echo "æ¸¬è©¦æª”æ¡ˆ: $TEST_FILES"
          echo "åŸå§‹ç¢¼æª”æ¡ˆ: $SOURCE_FILES"
          
          # è¨­å®šç’°å¢ƒè®Šæ•¸ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
          echo "TEST_FILES<<EOF" >> $GITHUB_ENV
          echo "$TEST_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "SOURCE_FILES<<EOF" >> $GITHUB_ENV
          echo "$SOURCE_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      
      - name: TDD phase validation
        run: |
          echo "ğŸ§ª TDD éšæ®µé©—è­‰..."
          
          if [ "$RED_PHASE" = "true" ]; then
            echo "RED éšæ®µæª¢æŸ¥:"
            echo "- æ‡‰è©²ä¸»è¦ä¿®æ”¹æ¸¬è©¦æª”æ¡ˆ"
            echo "- å¯èƒ½æœƒæœ‰å¤±æ•—çš„æ¸¬è©¦"
            
            if [ -n "$TEST_FILES" ]; then
              echo "âœ… ç™¼ç¾æ¸¬è©¦æª”æ¡ˆç•°å‹•ï¼Œç¬¦åˆ RED éšæ®µ"
            else
              echo "âš ï¸ RED éšæ®µä½†æœªç™¼ç¾æ¸¬è©¦æª”æ¡ˆç•°å‹•"
            fi
            
          elif [ "$GREEN_PHASE" = "true" ]; then
            echo "GREEN éšæ®µæª¢æŸ¥:"
            echo "- æ‡‰è©²ä¸»è¦ä¿®æ”¹åŸå§‹ç¢¼"
            echo "- æ‰€æœ‰æ¸¬è©¦å¿…é ˆé€šé"
            echo "REQUIRE_ALL_TESTS_PASS=true" >> $GITHUB_ENV
            
          elif [ "$REFACTOR_PHASE" = "true" ]; then
            echo "REFACTOR éšæ®µæª¢æŸ¥:"
            echo "- åªæ‡‰ä¿®æ”¹åŸå§‹ç¢¼ï¼Œä¸æ‡‰ä¿®æ”¹æ¸¬è©¦"
            echo "- æ‰€æœ‰æ¸¬è©¦å¿…é ˆé€šé"
            echo "- æ¸¬è©¦è¦†è“‹ç‡ä¸æ‡‰ä¸‹é™"
            echo "REQUIRE_ALL_TESTS_PASS=true" >> $GITHUB_ENV
            echo "CHECK_COVERAGE_REGRESSION=true" >> $GITHUB_ENV
            
            if [ -n "$TEST_FILES" ]; then
              echo "âš ï¸ REFACTOR éšæ®µä¸æ‡‰ä¿®æ”¹æ¸¬è©¦æª”æ¡ˆ"
            fi
          fi

  # å‰ç«¯ TDD æ¸¬è©¦
  frontend-tdd-tests:
    name: Frontend TDD Tests
    runs-on: ubuntu-latest
    needs: tdd-validation
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run TDD test suite
        run: |
          cd frontend
          echo "ğŸ§ª åŸ·è¡Œå‰ç«¯ TDD æ¸¬è©¦å¥—ä»¶..."
          
          # 1. å–®å…ƒæ¸¬è©¦
          echo "ğŸ“‹ 1. åŸ·è¡Œå–®å…ƒæ¸¬è©¦..."
          npm run test:unit || TEST_FAILED=true
          
          # 2. çµ„ä»¶æ¸¬è©¦  
          echo "ğŸ“‹ 2. åŸ·è¡Œçµ„ä»¶æ¸¬è©¦..."
          npm run test:component || TEST_FAILED=true
          
          # 3. æ¸¬è©¦è¦†è“‹ç‡æª¢æŸ¥
          echo "ğŸ“‹ 3. æª¢æŸ¥æ¸¬è©¦è¦†è“‹ç‡..."
          npm run test:coverage || COVERAGE_FAILED=true
          
          # 4. æ•´åˆæ¸¬è©¦
          echo "ğŸ“‹ 4. åŸ·è¡Œæ•´åˆæ¸¬è©¦..."
          npm run test:integration || INTEGRATION_FAILED=true
          
          # çµæœè™•ç†
          if [ "$TEST_FAILED" = "true" ] && [ "$RED_PHASE" != "true" ]; then
            echo "âŒ æ¸¬è©¦å¤±æ•—ä¸”é RED éšæ®µ"
            exit 1
          elif [ "$TEST_FAILED" = "true" ] && [ "$RED_PHASE" = "true" ]; then
            echo "âœ… RED éšæ®µå…è¨±æ¸¬è©¦å¤±æ•—"
          fi
          
          if [ "$COVERAGE_FAILED" = "true" ]; then
            echo "âŒ æ¸¬è©¦è¦†è“‹ç‡æœªé” $TDD_COVERAGE_THRESHOLD% TDD æ¨™æº–"
            exit 1
          fi
          
          echo "âœ… å‰ç«¯ TDD æ¸¬è©¦å®Œæˆ"
        
        env:
          CI: true
          NODE_ENV: test
      
      - name: Upload frontend coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-coverage
          path: frontend/coverage/
          retention-days: 7

  # å¾Œç«¯ TDD æ¸¬è©¦
  backend-tdd-tests:
    name: Backend TDD Tests
    runs-on: ubuntu-latest
    needs: tdd-validation
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    strategy:
      matrix:
        service: [auth-service, data-service, ai-service, video-service]
      fail-fast: false
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          cd services/${{ matrix.service }}
          python -m pip install --upgrade pip
          
          # å®‰è£ä¾è³´
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          else
            # å®‰è£åŸºæœ¬æ¸¬è©¦ä¾è³´
            pip install pytest pytest-cov pytest-asyncio pytest-mock factory-boy
          fi
      
      - name: Run TDD test suite
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0
          JWT_SECRET: test-secret-key-for-tdd-testing
          ENVIRONMENT: testing
          TDD_MODE: true
        run: |
          cd services/${{ matrix.service }}
          echo "ğŸ§ª åŸ·è¡Œå¾Œç«¯ TDD æ¸¬è©¦å¥—ä»¶ - ${{ matrix.service }}..."
          
          # æª¢æŸ¥æ¸¬è©¦æª”æ¡ˆæ˜¯å¦å­˜åœ¨
          if [ ! -d tests ] && [ ! -f test_*.py ] && [ ! -f *_test.py ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°æ¸¬è©¦æª”æ¡ˆï¼Œè·³é ${{ matrix.service }}"
            exit 0
          fi
          
          # 1. å–®å…ƒæ¸¬è©¦
          echo "ğŸ“‹ 1. åŸ·è¡Œå–®å…ƒæ¸¬è©¦..."
          python -m pytest tests/unit/ -v --tb=short || UNIT_FAILED=true
          
          # 2. æ•´åˆæ¸¬è©¦
          echo "ğŸ“‹ 2. åŸ·è¡Œæ•´åˆæ¸¬è©¦..."
          python -m pytest tests/integration/ -v --tb=short || INTEGRATION_FAILED=true
          
          # 3. æ¸¬è©¦è¦†è“‹ç‡æª¢æŸ¥ï¼ˆTDD æ¨™æº–ï¼š90%ï¼‰
          echo "ğŸ“‹ 3. æª¢æŸ¥æ¸¬è©¦è¦†è“‹ç‡..."
          python -m pytest tests/ \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=html \
            --cov-fail-under=$TDD_COVERAGE_THRESHOLD \
            || COVERAGE_FAILED=true
          
          # 4. ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
          echo "ğŸ“‹ 4. ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥..."
          flake8 app/ --max-complexity=$TDD_COMPLEXITY_LIMIT || QUALITY_FAILED=true
          
          # çµæœè™•ç†
          if [ "$UNIT_FAILED" = "true" ] || [ "$INTEGRATION_FAILED" = "true" ]; then
            if [ "$RED_PHASE" != "true" ]; then
              echo "âŒ æ¸¬è©¦å¤±æ•—ä¸”é RED éšæ®µ"
              exit 1
            else
              echo "âœ… RED éšæ®µå…è¨±æ¸¬è©¦å¤±æ•—"
            fi
          fi
          
          if [ "$COVERAGE_FAILED" = "true" ]; then
            echo "âŒ æ¸¬è©¦è¦†è“‹ç‡æœªé” $TDD_COVERAGE_THRESHOLD% TDD æ¨™æº–"
            exit 1
          fi
          
          if [ "$QUALITY_FAILED" = "true" ]; then
            echo "âŒ ç¨‹å¼ç¢¼å“è³ªä¸ç¬¦åˆ TDD æ¨™æº–"
            exit 1
          fi
          
          echo "âœ… å¾Œç«¯ TDD æ¸¬è©¦å®Œæˆ - ${{ matrix.service }}"
      
      - name: Upload backend coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage-${{ matrix.service }}
          path: services/${{ matrix.service }}/htmlcov/
          retention-days: 7

  # Docker TDD æ¸¬è©¦
  docker-tdd-tests:
    name: Docker TDD Tests
    runs-on: ubuntu-latest
    needs: [frontend-tdd-tests, backend-tdd-tests]
    if: github.event_name == 'pull_request' || contains(github.ref, 'main')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Run Docker TDD test suite
        run: |
          echo "ğŸ³ åŸ·è¡Œ Docker TDD æ¸¬è©¦å¥—ä»¶..."
          
          # æª¢æŸ¥å¿…è¦æª”æ¡ˆ
          if [ ! -f docker-compose.test.yml ]; then
            echo "âŒ æœªæ‰¾åˆ° docker-compose.test.yml"
            exit 1
          fi
          
          # åŸ·è¡Œ Docker æ¸¬è©¦è…³æœ¬
          if [ -f scripts/run-docker-tests.sh ]; then
            echo "ğŸ“‹ åŸ·è¡Œå®Œæ•´ Docker æ¸¬è©¦æµç¨‹..."
            bash scripts/run-docker-tests.sh
          else
            echo "ğŸ“‹ åŸ·è¡ŒåŸºæœ¬ Docker æ¸¬è©¦..."
            
            # æ¸¬è©¦ Docker Compose é…ç½®
            docker compose -f docker-compose.test.yml config
            
            # å•Ÿå‹•æ¸¬è©¦ç’°å¢ƒ
            docker compose -f docker-compose.test.yml up -d postgres-test redis-test minio-test
            
            # ç­‰å¾…æœå‹™å°±ç·’
            sleep 30
            
            # åŸ·è¡Œæ¸¬è©¦
            docker compose -f docker-compose.test.yml run --rm frontend-test || echo "å‰ç«¯æ¸¬è©¦å¤±æ•—"
            docker compose -f docker-compose.test.yml run --rm auth-service-test || echo "èªè­‰æœå‹™æ¸¬è©¦å¤±æ•—"
            
            # æ¸…ç†
            docker compose -f docker-compose.test.yml down -v
          fi
          
          echo "âœ… Docker TDD æ¸¬è©¦å®Œæˆ"
      
      - name: Upload Docker test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docker-test-reports
          path: test-reports/
          retention-days: 7

  # TDD å ±å‘Šç”Ÿæˆ
  tdd-reporting:
    name: TDD Reporting
    runs-on: ubuntu-latest
    needs: [frontend-tdd-tests, backend-tdd-tests, docker-tdd-tests]
    if: always()
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          path: coverage-reports/
      
      - name: Generate TDD summary report
        run: |
          echo "ğŸ“Š ç”Ÿæˆ TDD æ‘˜è¦å ±å‘Š..."
          
          # å»ºç«‹å ±å‘Šç›®éŒ„
          mkdir -p tdd-reports
          
          # ç”Ÿæˆ HTML å ±å‘Š
          cat > tdd-reports/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>TDD CI/CD å ±å‘Š</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .header { background: #2196F3; color: white; padding: 20px; border-radius: 5px; }
                  .section { margin: 20px 0; padding: 15px; border-left: 4px solid #2196F3; }
                  .success { border-left-color: #4CAF50; }
                  .warning { border-left-color: #FF9800; }
                  .error { border-left-color: #F44336; }
                  .metric { display: inline-block; margin: 10px; padding: 10px; background: #f5f5f5; border-radius: 3px; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ğŸ§¬ TDD CI/CD æ¸¬è©¦å ±å‘Š</h1>
                  <p>æäº¤: ${{ github.sha }}</p>
                  <p>åˆ†æ”¯: ${{ github.ref_name }}</p>
              </div>
          EOF
          
          # æª¢æŸ¥æ¸¬è©¦çµæœ
          if [ "${{ needs.frontend-tdd-tests.result }}" = "success" ]; then
            echo '<div class="section success"><h2>âœ… å‰ç«¯ TDD æ¸¬è©¦é€šé</h2></div>' >> tdd-reports/index.html
          else
            echo '<div class="section error"><h2>âŒ å‰ç«¯ TDD æ¸¬è©¦å¤±æ•—</h2></div>' >> tdd-reports/index.html
          fi
          
          if [ "${{ needs.backend-tdd-tests.result }}" = "success" ]; then
            echo '<div class="section success"><h2>âœ… å¾Œç«¯ TDD æ¸¬è©¦é€šé</h2></div>' >> tdd-reports/index.html
          else
            echo '<div class="section error"><h2>âŒ å¾Œç«¯ TDD æ¸¬è©¦å¤±æ•—</h2></div>' >> tdd-reports/index.html
          fi
          
          # æ·»åŠ æŒ‡æ¨™
          cat >> tdd-reports/index.html << 'EOF'
              <div class="section">
                  <h2>ğŸ“Š TDD æŒ‡æ¨™</h2>
                  <div class="metric">
                      <strong>è¦†è“‹ç‡è¦æ±‚:</strong> â‰¥90%
                  </div>
                  <div class="metric">
                      <strong>è¤‡é›œåº¦é™åˆ¶:</strong> â‰¤10
                  </div>
                  <div class="metric">
                      <strong>æ¸¬è©¦åŸ·è¡Œæ™‚é–“:</strong> <10åˆ†é˜
                  </div>
              </div>
              
              <div class="section">
                  <h2>ğŸ”— ç›¸é—œé€£çµ</h2>
                  <ul>
                      <li><a href="../coverage-reports/">æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š</a></li>
                      <li><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">CI/CD åŸ·è¡Œè©³æƒ…</a></li>
                  </ul>
              </div>
          </body>
          </html>
          EOF
          
          echo "âœ… TDD å ±å‘Šç”Ÿæˆå®Œæˆ"
      
      - name: Upload TDD reports
        uses: actions/upload-artifact@v4
        with:
          name: tdd-reports
          path: tdd-reports/
          retention-days: 30
      
      - name: Comment PR with TDD results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const frontendResult = '${{ needs.frontend-tdd-tests.result }}';
            const backendResult = '${{ needs.backend-tdd-tests.result }}';
            const dockerResult = '${{ needs.docker-tdd-tests.result }}';
            
            const body = `
            ## ğŸ§¬ TDD CI/CD æ¸¬è©¦çµæœ
            
            | æ¸¬è©¦é¡å‹ | çµæœ |
            |---------|------|
            | å‰ç«¯ TDD æ¸¬è©¦ | ${frontendResult === 'success' ? 'âœ… é€šé' : 'âŒ å¤±æ•—'} |
            | å¾Œç«¯ TDD æ¸¬è©¦ | ${backendResult === 'success' ? 'âœ… é€šé' : 'âŒ å¤±æ•—'} |
            | Docker TDD æ¸¬è©¦ | ${dockerResult === 'success' ? 'âœ… é€šé' : 'âŒ å¤±æ•—'} |
            
            ### TDD å“è³ªæŒ‡æ¨™
            - æ¸¬è©¦è¦†è“‹ç‡è¦æ±‚: â‰¥90%
            - ç¨‹å¼ç¢¼è¤‡é›œåº¦é™åˆ¶: â‰¤10
            - éµå¾ª Red-Green-Refactor å¾ªç’°
            
            [æŸ¥çœ‹è©³ç´°å ±å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # TDD éƒ¨ç½²æª¢æŸ¥
  tdd-deployment-check:
    name: TDD Deployment Check
    runs-on: ubuntu-latest
    needs: [tdd-reporting]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Final TDD validation
        run: |
          echo "ğŸš€ æœ€çµ‚ TDD é©—è­‰..."
          
          # æª¢æŸ¥æ‰€æœ‰æ¸¬è©¦æ˜¯å¦é€šé
          if [ "${{ needs.frontend-tdd-tests.result }}" != "success" ] || [ "${{ needs.backend-tdd-tests.result }}" != "success" ]; then
            echo "âŒ å­˜åœ¨å¤±æ•—çš„æ¸¬è©¦ï¼Œåœæ­¢éƒ¨ç½²"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰ TDD æª¢æŸ¥é€šéï¼Œå¯ä»¥éƒ¨ç½²"
          echo "DEPLOYMENT_APPROVED=true" >> $GITHUB_ENV
      
      - name: Trigger deployment
        if: env.DEPLOYMENT_APPROVED == 'true'
        run: |
          echo "ğŸš€ è§¸ç™¼éƒ¨ç½²æµç¨‹..."
          echo "âœ… åŸºæ–¼ TDD å“è³ªä¿è­‰çš„éƒ¨ç½²å·²æ‰¹å‡†"