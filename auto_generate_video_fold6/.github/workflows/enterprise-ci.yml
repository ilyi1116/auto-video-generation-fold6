name: ğŸ¢ ä¼æ¥­ç´š CI/CD æµæ°´ç·š

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ published ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # ğŸ” ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    name: ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ è¨­ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ å®‰è£ Python ä¾è³´
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          
      - name: ğŸ” Python ä»£ç¢¼æª¢æŸ¥
        run: |
          echo "::group::Black æ ¼å¼æª¢æŸ¥"
          black --check services/
          echo "::endgroup::"
          
          echo "::group::isort åŒ¯å…¥æ’åºæª¢æŸ¥"
          isort --check-only services/
          echo "::endgroup::"
          
          echo "::group::Flake8 èªæ³•æª¢æŸ¥"
          flake8 services/
          echo "::endgroup::"
          
          echo "::group::MyPy é¡å‹æª¢æŸ¥"
          mypy services/
          echo "::endgroup::"
          
      - name: ğŸ›¡ï¸ å®‰å…¨æ€§æƒæ (Bandit)
        run: |
          bandit -r services/ -f json -o bandit-report.json
          
      - name: ğŸ“¤ ä¸Šå‚³å®‰å…¨å ±å‘Š
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: bandit-report.json

  # ğŸ§ª è‡ªå‹•åŒ–æ¸¬è©¦
  test-backend:
    runs-on: ubuntu-latest
    name: å¾Œç«¯æ¸¬è©¦
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ è¨­ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          
      - name: ğŸ§ª é‹è¡Œå–®å…ƒæ¸¬è©¦
        env:
          DATABASE_URL: postgresql://postgres:test@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379
        run: |
          pytest tests/ -v \
            --cov=services \
            --cov-report=xml \
            --cov-report=html \
            --cov-fail-under=80 \
            --junitxml=test-results.xml
            
      - name: ğŸ“Š ä¸Šå‚³æ¸¬è©¦è¦†è“‹ç‡
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: true
          
      - name: ğŸ“¤ ä¸Šå‚³æ¸¬è©¦å ±å‘Š
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: backend-test-results
          path: |
            test-results.xml
            htmlcov/

  # ğŸŒ å‰ç«¯æ¸¬è©¦
  test-frontend:
    runs-on: ubuntu-latest
    name: å‰ç«¯æ¸¬è©¦
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
          
      - name: ğŸ“¦ å®‰è£ä¾è³´
        working-directory: frontend
        run: npm ci
        
      - name: ğŸ” TypeScript é¡å‹æª¢æŸ¥
        working-directory: frontend
        run: npm run type-check
        
      - name: ğŸ§ª é‹è¡Œå–®å…ƒæ¸¬è©¦
        working-directory: frontend
        run: npm run test:coverage
        
      - name: ğŸ­ é‹è¡Œ E2E æ¸¬è©¦
        working-directory: frontend
        run: |
          npm run build
          npm run test:e2e
          
      - name: ğŸ“¤ ä¸Šå‚³å‰ç«¯æ¸¬è©¦å ±å‘Š
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: frontend-test-results
          path: |
            frontend/coverage/
            frontend/playwright-report/

  # ğŸ³ Docker æ˜ åƒæ§‹å»º
  build-images:
    needs: [code-quality, test-backend, test-frontend]
    runs-on: ubuntu-latest
    name: æ§‹å»º Docker æ˜ åƒ
    permissions:
      contents: read
      packages: write
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ” ç™»å…¥å®¹å™¨è¨»å†Šè¡¨
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ“ æå–å…ƒæ•¸æ“š
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            
      - name: ğŸ—ï¸ è¨­ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ”¨ æ§‹å»ºä¸¦æ¨é€æ˜ åƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: ğŸ” æƒææ˜ åƒæ¼æ´
        if: github.event_name != 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          
      - name: ğŸ“¤ ä¸Šå‚³æ¼æ´æƒæçµæœ
        if: github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  # ğŸš€ éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
  deploy-staging:
    needs: [build-images]
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
    environment:
      name: staging
      url: https://staging.autovideo.com
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸš€ éƒ¨ç½²åˆ° Staging
        run: |
          echo "éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ..."
          # é€™è£¡æ‡‰è©²åŒ…å«å¯¦éš›çš„éƒ¨ç½²é‚è¼¯
          
      - name: ğŸ§ª é‹è¡Œå†’ç…™æ¸¬è©¦
        run: |
          echo "é‹è¡Œå†’ç…™æ¸¬è©¦..."
          # åŸºæœ¬å¥åº·æª¢æŸ¥æ¸¬è©¦
          
      - name: ğŸ“Š æ•ˆèƒ½åŸºæº–æ¸¬è©¦
        run: |
          echo "é‹è¡Œæ•ˆèƒ½æ¸¬è©¦..."
          # è¼‰å…¥æ¸¬è©¦å’Œæ•ˆèƒ½åŸºæº–

  # ğŸ­ éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
  deploy-production:
    needs: [deploy-staging]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
    environment:
      name: production
      url: https://autovideo.com
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸš€ è—ç¶ éƒ¨ç½²
        run: |
          echo "åŸ·è¡Œè—ç¶ éƒ¨ç½²..."
          # å¯¦éš›çš„ç”Ÿç”¢éƒ¨ç½²é‚è¼¯
          
      - name: ğŸ“ˆ æ›´æ–°ç›£æ§å‘Šè­¦
        run: |
          echo "æ›´æ–°ç›£æ§é…ç½®..."
          # æ›´æ–° Prometheus è¦å‰‡å’Œ Grafana å„€è¡¨æ¿
          
      - name: ğŸ“¢ ç™¼é€éƒ¨ç½²é€šçŸ¥
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          text: |
            ğŸš€ ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å®Œæˆ
            ç‰ˆæœ¬: ${{ github.ref_name }}
            ç‹€æ…‹: ${{ job.status }}

  # ğŸ“Š æ•ˆèƒ½ç›£æ§
  performance-monitoring:
    needs: [deploy-production]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    name: æ•ˆèƒ½ç›£æ§èˆ‡å ±å‘Š
    steps:
      - name: ğŸ“ˆ Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: https://autovideo.com
          configPath: .lighthouserc.json
          
      - name: ğŸ“Š ç”Ÿæˆæ•ˆèƒ½å ±å‘Š
        run: |
          echo "ç”Ÿæˆæ•ˆèƒ½åˆ†æå ±å‘Š..."
          
      - name: ğŸ“¤ ä¸Šå‚³æ•ˆèƒ½å ±å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: performance-reports
          path: lighthouse-reports/

  # ğŸ”” é€šçŸ¥èˆ‡å ±å‘Š
  notify:
    if: always()
    needs: [code-quality, test-backend, test-frontend, build-images]
    runs-on: ubuntu-latest
    name: é€šçŸ¥èˆ‡å ±å‘Š
    steps:
      - name: ğŸ“Š ç”ŸæˆåŸ·è¡Œæ‘˜è¦
        run: |
          echo "## ğŸš€ CI/CD åŸ·è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| éšæ®µ | ç‹€æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ç¨‹å¼ç¢¼å“è³ª | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å¾Œç«¯æ¸¬è©¦ | ${{ needs.test-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å‰ç«¯æ¸¬è©¦ | ${{ needs.test-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ˜ åƒæ§‹å»º | ${{ needs.build-images.result }} |" >> $GITHUB_STEP_SUMMARY
          
      - name: ğŸ“§ ç™¼é€ Email é€šçŸ¥
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ CI/CD æµæ°´ç·šå¤±æ•— - ${{ github.repository }}"
          body: |
            CI/CD æµæ°´ç·šåœ¨ ${{ github.ref }} åˆ†æ”¯ä¸Šå¤±è´¥ã€‚
            
            è«‹æª¢æŸ¥ GitHub Actions æ—¥èªŒä»¥äº†è§£è©³ç´°ä¿¡æ¯ï¼š
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: devops@autovideo.com