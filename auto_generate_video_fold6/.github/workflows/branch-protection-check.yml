name: Branch Protection Check

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # åŸºæœ¬æª¢æŸ¥
  basic-checks:
    name: Basic Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check branch protection status
        run: |
          echo "ğŸ›¡ï¸ æª¢æŸ¥åˆ†æ”¯ä¿è­·ç‹€æ…‹..."
          echo "Base branch: ${{ github.base_ref }}"
          echo "Head branch: ${{ github.head_ref }}"
          echo "PR number: ${{ github.event.number }}"

  # ä»£ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: basic-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Run ESLint
        run: |
          cd frontend
          npm run lint || echo "âš ï¸ ESLint æª¢æŸ¥ç™¼ç¾å•é¡Œ"

      - name: Run Prettier check
        run: |
          cd frontend
          npm run format:check || echo "âš ï¸ Prettier æ ¼å¼æª¢æŸ¥ç™¼ç¾å•é¡Œ"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black mypy

      - name: Run Python linting
        run: |
          find services -name "*.py" -exec ruff check {} + || echo "âš ï¸ Ruff æª¢æŸ¥ç™¼ç¾å•é¡Œ"
          find services -name "*.py" -exec black --check {} + || echo "âš ï¸ Black æ ¼å¼æª¢æŸ¥ç™¼ç¾å•é¡Œ"

  # æ¸¬è©¦åŸ·è¡Œ
  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: basic-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Run frontend tests
        run: |
          cd frontend
          npm run test

      - name: Run frontend tests with coverage
        run: |
          cd frontend
          npm run test:coverage

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov

      - name: Run Python tests
        run: |
          find services -name "requirements*.txt" -exec pip install -r {} +
          python -m pytest services/ --cov=services/ || echo "âš ï¸ Python æ¸¬è©¦ç™¼ç¾å•é¡Œ"

  # TypeScript é¡å‹æª¢æŸ¥
  typecheck:
    name: TypeScript Check
    runs-on: ubuntu-latest
    needs: basic-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run TypeScript check
        run: |
          cd frontend
          npm run check

  # æ§‹å»ºæ¸¬è©¦
  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    needs: basic-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Test Docker build
        run: |
          docker build -t test-frontend ./frontend || echo "âš ï¸ Docker æ§‹å»ºç™¼ç¾å•é¡Œ"

  # å®‰å…¨æƒæ
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: basic-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run npm audit
        run: |
          cd frontend
          npm audit --audit-level high || echo "âš ï¸ npm audit ç™¼ç¾é«˜é¢¨éšªæ¼æ´"

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ä¾è³´æª¢æŸ¥
  dependency-scan:
    name: Dependency Scan
    runs-on: ubuntu-latest
    needs: basic-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Check for vulnerable dependencies
        run: |
          cd frontend
          npm audit --audit-level moderate || echo "âš ï¸ ç™¼ç¾ä¸­ç­‰é¢¨éšªä¾è³´æ¼æ´"

      - name: Check for outdated dependencies
        run: |
          cd frontend
          npm outdated || echo "ğŸ“¦ æœ‰ä¾è³´å¯ä»¥æ›´æ–°"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install safety
        run: pip install safety

      - name: Check Python dependencies
        run: |
          find services -name "requirements*.txt" -exec safety check -r {} + || echo "âš ï¸ ç™¼ç¾ Python ä¾è³´æ¼æ´"

  # PR å“è³ªæª¢æŸ¥
  pr-quality-check:
    name: PR Quality Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"
          
          # æª¢æŸ¥ PR æ¨™é¡Œæ ¼å¼ (type: description)
          if [[ ! $PR_TITLE =~ ^(feat|fix|docs|style|refactor|perf|test|chore|security)(\(.+\))?: .+ ]]; then
            echo "âŒ PR æ¨™é¡Œæ ¼å¼ä¸æ­£ç¢º"
            echo "æ­£ç¢ºæ ¼å¼: type(scope): description"
            echo "ç¯„ä¾‹: feat(auth): add login functionality"
            exit 1
          else
            echo "âœ… PR æ¨™é¡Œæ ¼å¼æ­£ç¢º"
          fi

      - name: Check PR description
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          if [[ -z "$PR_BODY" || ${#PR_BODY} -lt 50 ]]; then
            echo "âŒ PR æè¿°å¤ªçŸ­æˆ–ç‚ºç©º"
            echo "è«‹æä¾›è©³ç´°çš„è®Šæ›´æè¿°"
            exit 1
          else
            echo "âœ… PR æè¿°ç¬¦åˆè¦æ±‚"
          fi

      - name: Check changed files
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          echo "è®Šæ›´çš„æª”æ¡ˆ:"
          echo "$CHANGED_FILES"
          
          # æª¢æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿæª”æ¡ˆè®Šæ›´
          SENSITIVE_FILES=(
            ".env"
            "docker-compose.yml"
            ".github/workflows/"
            "pyproject.toml"
          )
          
          for file in $CHANGED_FILES; do
            for sensitive in "${SENSITIVE_FILES[@]}"; do
              if [[ $file == *"$sensitive"* ]]; then
                echo "âš ï¸ æ³¨æ„ï¼šè®Šæ›´äº†æ•æ„Ÿæª”æ¡ˆ $file"
              fi
            done
          done

      - name: Check commit messages
        run: |
          COMMITS=$(git log --pretty=format:"%s" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          echo "æäº¤è¨Šæ¯:"
          echo "$COMMITS"
          
          # æª¢æŸ¥æ˜¯å¦æœ‰ WIP æäº¤
          if echo "$COMMITS" | grep -i "wip\|work in progress\|tmp\|temp"; then
            echo "âš ï¸ ç™¼ç¾ WIP æˆ–è‡¨æ™‚æäº¤ï¼Œè«‹è€ƒæ…®æ¸…ç†æäº¤æ­·å²"
          fi

  # æœ€çµ‚ç‹€æ…‹æª¢æŸ¥
  final-check:
    name: Final Status Check
    runs-on: ubuntu-latest
    needs: [code-quality, run-tests, typecheck, build-test, security-scan, dependency-scan]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          echo "ğŸ“Š æª¢æŸ¥æ‰€æœ‰å·¥ä½œç‹€æ…‹..."
          
          # æª¢æŸ¥å¿…è¦å·¥ä½œçš„ç‹€æ…‹
          CODE_QUALITY="${{ needs.code-quality.result }}"
          TESTS="${{ needs.run-tests.result }}"
          TYPECHECK="${{ needs.typecheck.result }}"
          BUILD="${{ needs.build-test.result }}"
          SECURITY="${{ needs.security-scan.result }}"
          DEPS="${{ needs.dependency-scan.result }}"
          
          echo "ä»£ç¢¼å“è³ª: $CODE_QUALITY"
          echo "æ¸¬è©¦: $TESTS"
          echo "é¡å‹æª¢æŸ¥: $TYPECHECK" 
          echo "æ§‹å»º: $BUILD"
          echo "å®‰å…¨æƒæ: $SECURITY"
          echo "ä¾è³´æª¢æŸ¥: $DEPS"
          
          # å¦‚æœæœ‰ä»»ä½•å¿…è¦æª¢æŸ¥å¤±æ•—ï¼Œæ•´å€‹æª¢æŸ¥å¤±æ•—
          if [[ "$CODE_QUALITY" == "failure" || "$TESTS" == "failure" || "$TYPECHECK" == "failure" || "$BUILD" == "failure" ]]; then
            echo "âŒ å¿…è¦æª¢æŸ¥å¤±æ•—ï¼Œè«‹ä¿®å¾©å•é¡Œå¾Œå†æ¬¡æäº¤"
            exit 1
          fi
          
          # è­¦å‘Šæ€§æª¢æŸ¥
          if [[ "$SECURITY" == "failure" || "$DEPS" == "failure" ]]; then
            echo "âš ï¸ å®‰å…¨æˆ–ä¾è³´æª¢æŸ¥ç™¼ç¾å•é¡Œï¼Œè«‹æª¢æŸ¥ä¸¦è©•ä¼°é¢¨éšª"
          fi
          
          echo "âœ… æ‰€æœ‰å¿…è¦æª¢æŸ¥é€šéï¼"

      - name: Post success comment
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **åˆ†æ”¯ä¿è­·æª¢æŸ¥é€šé**\n\næ‰€æœ‰å¿…è¦çš„å“è³ªæª¢æŸ¥éƒ½å·²é€šéï¼Œæ­¤ PR å¯ä»¥é€²è¡Œå¯©æŸ¥ã€‚'
            })

      - name: Post failure comment
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **åˆ†æ”¯ä¿è­·æª¢æŸ¥å¤±æ•—**\n\nè«‹æª¢æŸ¥ä¸Šæ–¹çš„éŒ¯èª¤è¨Šæ¯ï¼Œä¿®å¾©å•é¡Œå¾Œé‡æ–°æ¨é€ã€‚'
            })