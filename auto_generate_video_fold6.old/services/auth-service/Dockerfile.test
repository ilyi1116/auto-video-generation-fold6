# èªè­‰æœå‹™æ¸¬è©¦å°ˆç”¨ Dockerfile
# é‡å° TDD å·¥ä½œæµç¨‹å„ªåŒ–

FROM python:3.11-slim

WORKDIR /app

# å®‰è£ç³»çµ±ä¾è³´
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    netcat-openbsd \
    curl \
    && rm -rf /var/lib/apt/lists/*

# è¤‡è£½ä¾è³´æª”æ¡ˆ
COPY requirements.txt requirements-dev.txt ./

# å®‰è£ Python ä¾è³´ï¼ˆåŒ…å«é–‹ç™¼ä¾è³´ï¼‰
RUN pip install --no-cache-dir -r requirements.txt
RUN pip install --no-cache-dir -r requirements-dev.txt

# å‰µå»ºéç‰¹æ¬Šç”¨æˆ¶
RUN groupadd -r testuser && useradd -r -g testuser testuser

# è¤‡è£½æ‡‰ç”¨ç¨‹å¼ç¢¼ä¸¦è¨­ç½®æ¬Šé™
COPY . .
RUN chown -R testuser:testuser /app

# å»ºç«‹æ¸¬è©¦è…³æœ¬
RUN echo '#!/bin/bash\n\
set -e\n\
echo "ğŸ§ª åŸ·è¡Œèªè­‰æœå‹™ TDD æ¸¬è©¦å¥—ä»¶..."\n\
echo ""\n\
echo "ğŸ“‹ 1. ç­‰å¾…è³‡æ–™åº«é€£æ¥..."\n\
while ! nc -z postgres-test 5432; do\n\
  echo "ç­‰å¾… PostgreSQL..."\n\
  sleep 1\n\
done\n\
echo "âœ… PostgreSQL å·²å°±ç·’"\n\
echo ""\n\
echo "ğŸ“‹ 2. ç­‰å¾… Redis é€£æ¥..."\n\
while ! nc -z redis-test 6379; do\n\
  echo "ç­‰å¾… Redis..."\n\
  sleep 1\n\
done\n\
echo "âœ… Redis å·²å°±ç·’"\n\
echo ""\n\
echo "ğŸ“‹ 3. åˆå§‹åŒ–æ¸¬è©¦è³‡æ–™åº«..."\n\
python -c "from app.database import engine; from app.models import Base; Base.metadata.create_all(bind=engine)"\n\
echo "âœ… æ¸¬è©¦è³‡æ–™åº«åˆå§‹åŒ–å®Œæˆ"\n\
echo ""\n\
echo "ğŸ“‹ 4. åŸ·è¡Œå–®å…ƒæ¸¬è©¦..."\n\
python -m pytest tests/unit/ -v --tb=short || exit 1\n\
echo ""\n\
echo "ğŸ“‹ 5. åŸ·è¡Œæ•´åˆæ¸¬è©¦..."\n\
python -m pytest tests/integration/ -v --tb=short || exit 1\n\
echo ""\n\
echo "ğŸ“‹ 6. æª¢æŸ¥æ¸¬è©¦è¦†è“‹ç‡ (â‰¥90%)..."\n\
python -m pytest tests/ --cov=app --cov-report=term-missing --cov-report=html --cov-fail-under=90 || exit 1\n\
echo ""\n\
echo "ğŸ“‹ 7. ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥..."\n\
flake8 app/ --max-complexity=10 || exit 1\n\
echo ""\n\
echo "âœ… æ‰€æœ‰èªè­‰æœå‹™æ¸¬è©¦é€šéï¼"\n\
' > /app/run-tests.sh && chmod +x /app/run-tests.sh

# åˆ‡æ›åˆ°éç‰¹æ¬Šç”¨æˆ¶
USER testuser

# é è¨­åŸ·è¡Œæ¸¬è©¦
CMD ["/app/run-tests.sh"]

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
  CMD python -c "import app; print('Health check passed')" || exit 1