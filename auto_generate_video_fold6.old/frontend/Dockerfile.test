# å‰ç«¯æ¸¬è©¦å°ˆç”¨ Dockerfile
# é‡å° TDD å·¥ä½œæµç¨‹å„ªåŒ–

FROM node:18-alpine

WORKDIR /app

# å®‰è£ç³»çµ±ä¾è³´
RUN apk add --no-cache \
    chromium \
    nss \
    freetype \
    freetype-dev \
    harfbuzz \
    ca-certificates \
    ttf-freefont

# è¨­å®š Chromium ç’°å¢ƒè®Šæ•¸ï¼ˆç”¨æ–¼ Playwrightï¼‰
ENV CHROMIUM_PATH=/usr/bin/chromium-browser
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

# è¤‡è£½ package.json å’Œ package-lock.json
COPY package*.json ./

# å®‰è£ä¾è³´ï¼ˆåŒ…å«é–‹ç™¼ä¾è³´ï¼‰
RUN npm ci

# å‰µå»ºéç‰¹æ¬Šç”¨æˆ¶
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nextjs -u 1001

# è¤‡è£½å°ˆæ¡ˆæª”æ¡ˆä¸¦è¨­ç½®æ¬Šé™
COPY . .
RUN chown -R nextjs:nodejs /app

# å»ºç«‹æ¸¬è©¦è…³æœ¬
RUN echo '#!/bin/sh\n\
echo "ğŸ§ª åŸ·è¡Œå‰ç«¯ TDD æ¸¬è©¦å¥—ä»¶..."\n\
echo ""\n\
echo "ğŸ“‹ 1. åŸ·è¡Œå–®å…ƒæ¸¬è©¦..."\n\
npm run test:unit || exit 1\n\
echo ""\n\
echo "ğŸ“‹ 2. æª¢æŸ¥æ¸¬è©¦è¦†è“‹ç‡ (â‰¥90%)..."\n\
npm run test:coverage || exit 1\n\
echo ""\n\
echo "ğŸ“‹ 3. åŸ·è¡Œçµ„ä»¶æ¸¬è©¦..."\n\
npm run test:component || exit 1\n\
echo ""\n\
echo "ğŸ“‹ 4. åŸ·è¡Œæ•´åˆæ¸¬è©¦..."\n\
npm run test:integration || exit 1\n\
echo ""\n\
echo "ğŸ“‹ 5. åŸ·è¡Œ E2E æ¸¬è©¦..."\n\
npm run test:e2e:headless || exit 1\n\
echo ""\n\
echo "âœ… æ‰€æœ‰å‰ç«¯æ¸¬è©¦é€šéï¼"\n\
' > /app/run-tests.sh && chmod +x /app/run-tests.sh

# åˆ‡æ›åˆ°éç‰¹æ¬Šç”¨æˆ¶
USER nextjs

# é è¨­åŸ·è¡Œæ¸¬è©¦
CMD ["/app/run-tests.sh"]

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD node --version || exit 1