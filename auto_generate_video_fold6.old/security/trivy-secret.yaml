# Trivy 密鑰檢測配置

# 全域設定
global:
  disable-secret-scan: false
  secret-patterns:
    - pattern: '(?i)(api[_-]?key|apikey)\s*[:=]\s*["\']?([a-zA-Z0-9]{32,})["\']?'
      description: "API Keys"
      severity: HIGH
    
    - pattern: '(?i)(secret[_-]?key|secretkey)\s*[:=]\s*["\']?([a-zA-Z0-9]{32,})["\']?'
      description: "Secret Keys"
      severity: CRITICAL
    
    - pattern: '(?i)(password|passwd|pwd)\s*[:=]\s*["\']?([a-zA-Z0-9!@#$%^&*()]{8,})["\']?'
      description: "Passwords"
      severity: HIGH
    
    - pattern: '(?i)(token|auth[_-]?token)\s*[:=]\s*["\']?([a-zA-Z0-9._-]{20,})["\']?'
      description: "Authentication Tokens"
      severity: HIGH
    
    - pattern: 'sk-[a-zA-Z0-9]{48}'
      description: "OpenAI API Keys"
      severity: CRITICAL
    
    - pattern: 'ghp_[a-zA-Z0-9]{36}'
      description: "GitHub Personal Access Tokens"
      severity: HIGH
    
    - pattern: 'gho_[a-zA-Z0-9]{36}'
      description: "GitHub OAuth Tokens"
      severity: HIGH
    
    - pattern: 'AKIA[0-9A-Z]{16}'
      description: "AWS Access Key IDs"
      severity: CRITICAL
    
    - pattern: '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}'
      description: "UUIDs (potential secrets)"
      severity: MEDIUM
    
    - pattern: '(?i)jwt\s*[:=]\s*["\']?eyJ[a-zA-Z0-9._-]+["\']?'
      description: "JWT Tokens"
      severity: HIGH
    
    - pattern: '(?i)(database[_-]?url|db[_-]?url)\s*[:=]\s*["\']?([a-zA-Z0-9+._://@-]+)["\']?'
      description: "Database URLs"
      severity: HIGH
    
    - pattern: '(?i)(redis[_-]?url)\s*[:=]\s*["\']?([a-zA-Z0-9+._://@-]+)["\']?'
      description: "Redis URLs"
      severity: MEDIUM
    
    - pattern: '-----BEGIN [A-Z ]+-----[\s\S]*?-----END [A-Z ]+-----'
      description: "Private Keys"
      severity: CRITICAL

# 檔案類型特定設定
file-patterns:
  # Python 檔案
  python:
    extensions: [".py", ".pyw"]
    patterns:
      - pattern: '(?i)django[_-]?secret[_-]?key\s*=\s*["\']([a-zA-Z0-9!@#$%^&*()_+-={}|[\]\\:";\'<>?,./]{50})["\']'
        description: "Django Secret Key"
        severity: CRITICAL
      
      - pattern: '(?i)flask[_-]?secret[_-]?key\s*=\s*["\']([a-zA-Z0-9!@#$%^&*()_+-={}|[\]\\:";\'<>?,./]{16,})["\']'
        description: "Flask Secret Key"
        severity: CRITICAL
  
  # JavaScript/TypeScript 檔案
  javascript:
    extensions: [".js", ".ts", ".jsx", ".tsx", ".mjs"]
    patterns:
      - pattern: '(?i)(process\.env\.|process\.env\[)["\']?([A-Z_]+)["\']?\s*[:=]\s*["\']?([a-zA-Z0-9!@#$%^&*()_+-={}|[\]\\:";\'<>?,./]{8,})["\']?'
        description: "Environment Variables"
        severity: MEDIUM
  
  # 配置檔案
  config:
    extensions: [".env", ".config", ".ini", ".conf", ".yaml", ".yml", ".json"]
    patterns:
      - pattern: '(?i)^[A-Z_]+\s*=\s*["\']?([a-zA-Z0-9!@#$%^&*()_+-={}|[\]\\:";\'<>?,./]{8,})["\']?\s*$'
        description: "Environment Variable in Config"
        severity: MEDIUM

# 忽略規則
ignore:
  paths:
    - "**/test/**"
    - "**/tests/**"
    - "**/*_test.*"
    - "**/example/**"
    - "**/examples/**"
    - "**/docs/**"
    - "**/documentation/**"
    - "**/.git/**"
    - "**/node_modules/**"
    - "**/vendor/**"
    - "**/__pycache__/**"
    - "**/coverage/**"
    - "**/build/**"
    - "**/dist/**"
  
  patterns:
    # 測試用的假密鑰
    - 'test[_-]?api[_-]?key'
    - 'example[_-]?secret'
    - 'dummy[_-]?password'
    - 'fake[_-]?token'
    - 'sample[_-]?key'
    - 'placeholder'
    - 'your[_-]?api[_-]?key[_-]?here'
    - 'insert[_-]?key[_-]?here'
    
    # 常見的測試值
    - '123456789'
    - 'abcdefghijklmnop'
    - 'test-secret-key'
    - 'development-only'
    
    # UUID 模板
    - '00000000-0000-0000-0000-000000000000'
    - 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'

# 掃描設定
scan-settings:
  max-file-size: 10MB
  scan-timeout: 30s
  
  # 深度掃描設定
  deep-scan:
    enabled: true
    max-depth: 10
    entropy-threshold: 4.5
  
  # 誤報減少設定
  false-positive-reduction:
    enabled: true
    confidence-threshold: 0.8
    
    # 上下文分析
    context-analysis:
      enabled: true
      surrounding-lines: 3
      
      # 排除模式
      exclude-contexts:
        - "# TODO:"
        - "# FIXME:"
        - "# NOTE:"
        - "// TODO:"
        - "// FIXME:"
        - "// NOTE:"
        - "console.log"
        - "print("
        - "logger."
        - "log."

# 報告設定
reporting:
  formats:
    - json
    - sarif
    - markdown
  
  include-suppressed: false
  include-low-severity: false
  
  # 自訂報告範本
  template: |
    # Security Scan Report - Secrets Detection
    
    **Scan Date:** {{ .ScanDate }}
    **Target:** {{ .Target }}
    **Scanner:** Trivy Secret Detection
    
    ## Summary
    
    | Severity | Count |
    |----------|-------|
    | Critical | {{ .CriticalCount }} |
    | High     | {{ .HighCount }} |
    | Medium   | {{ .MediumCount }} |
    | Low      | {{ .LowCount }} |
    
    ## Findings
    
    {{ range .Findings }}
    ### {{ .Severity }}: {{ .Description }}
    
    **File:** `{{ .Filename }}`
    **Line:** {{ .LineNumber }}
    **Pattern:** `{{ .Pattern }}`
    
    ```
    {{ .Code }}
    ```
    
    **Recommendation:** {{ .Recommendation }}
    
    ---
    {{ end }}
  
  # 通知設定
  notifications:
    webhook:
      enabled: true
      url: "http://alertmanager:9093/api/v1/alerts"
      headers:
        Content-Type: "application/json"
    
    email:
      enabled: false
      smtp-server: "smtp.company.com:587"
      from: "security@auto-video-system.com"
      to: ["security-team@auto-video-system.com"]

# 效能調整
performance:
  parallel-scans: 4
  memory-limit: 512MB
  cache-ttl: 24h
  
  # 大檔案處理
  large-file-handling:
    chunk-size: 1MB
    max-chunks: 100