apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: auto-video-ingress
  namespace: auto-video
  labels:
    app.kubernetes.io/name: auto-video
    app.kubernetes.io/component: ingress
    app.kubernetes.io/part-of: auto-video-system
  annotations:
    # Ingress Controller 設定
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
    
    # SSL 設定
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-protocols: "TLSv1.2 TLSv1.3"
    nginx.ingress.kubernetes.io/ssl-ciphers: "ECDHE-RSA-AES128-GCM-SHA256,ECDHE-RSA-AES256-GCM-SHA384"
    
    # 安全標頭
    nginx.ingress.kubernetes.io/server-snippet: |
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header Referrer-Policy "no-referrer-when-downgrade" always;
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # 速率限制
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    
    # 文件上傳大小限制
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    
    # CORS 設定
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://autovideo.yourdomain.com"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET,POST,PUT,DELETE,OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Content-Type,Authorization,X-Requested-With"

spec:
  tls:
  - hosts:
    - autovideo.yourdomain.com
    - api.autovideo.yourdomain.com
    secretName: auto-video-tls
  
  rules:
  # 主網站 (前端)
  - host: autovideo.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-service
            port:
              number: 80
  
  # API 端點
  - host: api.autovideo.yourdomain.com
    http:
      paths:
      # API 路由
      - path: /api/v1
        pathType: Prefix
        backend:
          service:
            name: api-gateway-service
            port:
              number: 8000
      
      # 健康檢查
      - path: /health
        pathType: Exact
        backend:
          service:
            name: api-gateway-service
            port:
              number: 8000
      
      # 檔案上傳 (特殊處理)
      - path: /api/v1/upload
        pathType: Prefix
        backend:
          service:
            name: api-gateway-service
            port:
              number: 8000

---
# 監控系統 Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: monitoring-ingress
  namespace: auto-video-monitoring
  labels:
    app.kubernetes.io/name: auto-video
    app.kubernetes.io/component: monitoring-ingress
    app.kubernetes.io/part-of: auto-video-system
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    
    # 基本認證保護
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: monitoring-auth
    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required - Auto Video Monitoring'
    
    # IP 白名單 (根據需要調整)
    nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"

spec:
  tls:
  - hosts:
    - monitoring.autovideo.yourdomain.com
    - grafana.autovideo.yourdomain.com
    - prometheus.autovideo.yourdomain.com
    secretName: monitoring-tls
  
  rules:
  # Grafana 儀表板
  - host: grafana.autovideo.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: grafana-service
            port:
              number: 3000
  
  # Prometheus 查詢介面
  - host: prometheus.autovideo.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: prometheus-service
            port:
              number: 9090

---
# 監控認證密鑰
apiVersion: v1
kind: Secret
metadata:
  name: monitoring-auth
  namespace: auto-video-monitoring
  labels:
    app.kubernetes.io/name: auto-video
    app.kubernetes.io/component: monitoring-auth
    app.kubernetes.io/part-of: auto-video-system
type: Opaque
data:
  # admin:password123 (htpasswd 格式)
  auth: YWRtaW46JGFwcjEkSDZsaVJDek4kWjk2aVAxaDBsRHozTk1nVjY2WC9KMQo=