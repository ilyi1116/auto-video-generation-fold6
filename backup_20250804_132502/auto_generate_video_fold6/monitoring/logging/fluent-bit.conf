[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        off
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    Health_Check  On

# 收集 Docker 容器日誌
[INPUT]
    Name              forward
    Listen            0.0.0.0
    Port              24224
    Buffer_Chunk_Size 1M
    Buffer_Max_Size   6M

# 收集應用程式日誌
[INPUT]
    Name                tail
    Path                /var/log/auto-video/*.log
    Parser              json
    Tag                 app.auto-video
    Refresh_Interval    5
    Mem_Buf_Limit       5MB
    Skip_Long_Lines     On

# 收集 Nginx 訪問日誌
[INPUT]
    Name                tail
    Path                /var/log/nginx/access.log
    Parser              nginx
    Tag                 nginx.access
    Refresh_Interval    5
    Mem_Buf_Limit       5MB

# 收集 Nginx 錯誤日誌
[INPUT]
    Name                tail
    Path                /var/log/nginx/error.log
    Parser              nginx_error
    Tag                 nginx.error
    Refresh_Interval    5
    Mem_Buf_Limit       5MB

# 收集系統日誌
[INPUT]
    Name                systemd
    Tag                 systemd.*
    Systemd_Filter      _SYSTEMD_UNIT=auto-video.service
    Strip_Underscores   On

# 過濾器：解析 JSON 日誌
[FILTER]
    Name                parser
    Match               app.auto-video
    Key_Name            log
    Parser              json
    Reserve_Data        On

# 過濾器：添加 Kubernetes 元數據
[FILTER]
    Name                kubernetes
    Match               kube.*
    Kube_URL            https://kubernetes.default.svc:443
    Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
    Kube_Tag_Prefix     kube.var.log.containers.
    Merge_Log           On
    Keep_Log            Off
    K8S-Logging.Parser  On
    K8S-Logging.Exclude Off

# 過濾器：添加服務標籤
[FILTER]
    Name                modify
    Match               app.auto-video
    Add                 service auto-video
    Add                 environment production
    Add                 version 1.0.0

# 過濾器：安全事件檢測
[FILTER]
    Name                grep
    Match               *
    Regex               log (failed login|unauthorized|403|401|security|breach|attack)
    Add                 alert_type security

# 過濾器：錯誤事件標記
[FILTER]
    Name                grep
    Match               *
    Regex               level (ERROR|CRITICAL|FATAL)
    Add                 alert_type error

# 過濾器：效能問題檢測
[FILTER]
    Name                grep
    Match               *
    Regex               response_time [5-9][0-9]{3}|[1-9][0-9]{4}
    Add                 alert_type performance

# 過濾器：資料豐富化
[FILTER]
    Name                record_modifier
    Match               *
    Record              hostname ${HOSTNAME}
    Record              datacenter ${DATACENTER}
    Record              cluster auto-video-cluster

# 輸出到 Elasticsearch
[OUTPUT]
    Name                es
    Match               app.auto-video
    Host                elasticsearch
    Port                9200
    Index               auto-video-logs
    Type                _doc
    Logstash_Format     On
    Logstash_Prefix     auto-video
    Logstash_DateFormat %Y.%m.%d
    Time_Key            @timestamp
    Time_Key_Format     %Y-%m-%dT%H:%M:%S.%L
    Include_Tag_Key     On
    Tag_Key             tag
    Retry_Limit         False

# 輸出 Nginx 日誌到 Elasticsearch
[OUTPUT]
    Name                es
    Match               nginx.*
    Host                elasticsearch
    Port                9200
    Index               nginx-logs
    Type                _doc
    Logstash_Format     On
    Logstash_Prefix     nginx
    Logstash_DateFormat %Y.%m.%d
    Time_Key            @timestamp
    Include_Tag_Key     On
    Tag_Key             tag

# 輸出系統日誌到 Elasticsearch
[OUTPUT]
    Name                es
    Match               systemd.*
    Host                elasticsearch
    Port                9200
    Index               system-logs
    Type                _doc
    Logstash_Format     On
    Logstash_Prefix     system
    Logstash_DateFormat %Y.%m.%d
    Time_Key            @timestamp
    Include_Tag_Key     On
    Tag_Key             tag

# 輸出安全事件到專用索引
[OUTPUT]
    Name                es
    Match_Regex         .*alert_type.*security.*
    Host                elasticsearch
    Port                9200
    Index               security-alerts
    Type                _doc
    Logstash_Format     On
    Logstash_Prefix     security
    Logstash_DateFormat %Y.%m.%d
    Time_Key            @timestamp
    Include_Tag_Key     On
    Tag_Key             tag

# 輸出關鍵錯誤到檔案備份
[OUTPUT]
    Name                file
    Match_Regex         .*alert_type.*error.*
    Path                /var/log/fluent-bit/
    File                critical-errors.log
    Format              json_lines

# 輸出到標準輸出（除錯用）
[OUTPUT]
    Name                stdout
    Match               *
    Format              json_lines