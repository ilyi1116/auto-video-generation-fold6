# ä¾èµ–ç®¡ç†å’Œå®‰å…¨ç›‘æ§å·¥ä½œæµç¨‹
name: ğŸ”’ Dependency & Security Management

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š 6:00 UTC è¿è¡Œ
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - dependencies-only
          - containers-only
  push:
    branches: [main]
    paths:
      - 'pyproject.toml'
      - '**/requirements*.txt'
      - 'src/frontend/package*.json'
      - '**/Dockerfile*'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

permissions:
  security-events: write
  contents: read
  pull-requests: write

jobs:
  # ===========================================
  # Python ä¾èµ–å®‰å…¨æ‰«æ
  # ===========================================
  python-security-scan:
    name: ğŸ Python Dependencies Security
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.scan_type == 'full' || inputs.scan_type == 'dependencies-only'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,test]"

    - name: ğŸ” Safety Check
      run: |
        pip install safety
        safety check --full-report --output text
        safety check --json --output safety-report.json || true

    - name: ğŸ” Bandit Security Check
      run: |
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ --severity-level medium --confidence-level high

    - name: ğŸ” Semgrep Security Analysis
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten
          p/python
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      continue-on-error: true

    - name: ğŸ“Š Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: python-security-reports
        path: |
          safety-report.json
          bandit-report.json

  # ===========================================
  # Node.js ä¾èµ–å®‰å…¨æ‰«æ
  # ===========================================
  nodejs-security-scan:
    name: ğŸŸ¢ Node.js Dependencies Security
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.scan_type == 'full' || inputs.scan_type == 'dependencies-only'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'src/frontend/package-lock.json'

    - name: ğŸ“¦ Install Dependencies
      working-directory: src/frontend
      run: npm ci

    - name: ğŸ” NPM Audit
      working-directory: src/frontend
      run: |
        npm audit --audit-level=moderate --json > npm-audit-report.json || true
        npm audit --audit-level=moderate

    - name: ğŸ” NPM Security Check
      working-directory: src/frontend
      run: |
        npx audit-ci --moderate || true

    - name: ğŸ“Š Upload Security Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: nodejs-security-reports
        path: src/frontend/npm-audit-report.json

  # ===========================================
  # å®¹å™¨å®‰å…¨æ‰«æ
  # ===========================================
  container-security-scan:
    name: ğŸ³ Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.scan_type == 'full' || inputs.scan_type == 'containers-only'
    
    strategy:
      matrix:
        base-image:
          - python:3.11-slim
          - node:18-alpine
          - nginx:alpine
          - postgres:15-alpine
          - redis:7-alpine

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ³ Run Trivy Container Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ matrix.base-image }}
        format: 'sarif'
        output: 'trivy-${{ matrix.base-image }}-results.sarif'

    - name: ğŸ“Š Upload Trivy Results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-${{ matrix.base-image }}-results.sarif'

  # ===========================================
  # ä¾èµ–æ›´æ–°å»ºè®®
  # ===========================================
  dependency-update:
    name: ğŸ”„ Dependency Update Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ” Check Python Updates
      run: |
        pip install pip-check-updates
        pip list --outdated > python-outdated.txt || true
        echo "=== Python Outdated Packages ===" >> dependency-update-report.txt
        cat python-outdated.txt >> dependency-update-report.txt

    - name: ğŸ” Check Node.js Updates
      working-directory: src/frontend
      run: |
        npm outdated > ../nodejs-outdated.txt || true
        echo "=== Node.js Outdated Packages ===" >> ../dependency-update-report.txt
        cat ../nodejs-outdated.txt >> ../dependency-update-report.txt

    - name: ğŸ“‹ Create Issue for Updates
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('dependency-update-report.txt')) {
            const report = fs.readFileSync('dependency-update-report.txt', 'utf8');
            if (report.trim()) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ“¦ Weekly Dependency Update Report - ${new Date().toISOString().split('T')[0]}`,
                body: \`## ä¾èµ–æ›´æ–°æŠ¥å‘Š\\n\\nä»¥ä¸‹ä¾èµ–åŒ…æœ‰å¯ç”¨çš„æ›´æ–°ï¼š\\n\\n\\\`\\\`\\\`\\n\${report}\\n\\\`\\\`\\\`\\n\\n### å»ºè®®æ“ä½œ\\n1. æ£€æŸ¥æ›´æ–°çš„å…¼å®¹æ€§\\n2. æµ‹è¯•æ›´æ–°åçš„åŠŸèƒ½\\n3. æ›´æ–° pyproject.toml å’Œ package.json\\n4. è¿è¡Œå®Œæ•´çš„æµ‹è¯•å¥—ä»¶\\n\\n### å®‰å…¨æé†’\\nä¼˜å…ˆæ›´æ–°æœ‰å®‰å…¨æ¼æ´çš„ä¾èµ–åŒ…ã€‚\\n\\n*æ­¤æŠ¥å‘Šç”±è‡ªåŠ¨åŒ–å·¥ä½œæµç¨‹ç”Ÿæˆ*\`,
                labels: ['dependencies', 'security', 'maintenance']
              });
            }
          }

  # ===========================================
  # å®‰å…¨æŠ¥å‘Šæ±‡æ€»
  # ===========================================
  security-summary:
    name: ğŸ“Š Security Summary Report
    runs-on: ubuntu-latest
    needs: [python-security-scan, nodejs-security-scan, container-security-scan]
    if: always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: ğŸ“¥ Download All Reports
      uses: actions/download-artifact@v5
      with:
        path: security-reports

    - name: ğŸ“‹ Generate Summary Report
      run: |
        echo "# ğŸ”’ Security Scan Summary Report" > security-summary.md
        echo "**Generated:** $(date)" >> security-summary.md
        echo "" >> security-summary.md
        
        echo "## Python Security Scan" >> security-summary.md
        if [ -f "security-reports/python-security-reports/safety-report.json" ]; then
          echo "- âœ… Safety scan completed" >> security-summary.md
        else
          echo "- âŒ Safety scan failed or not run" >> security-summary.md
        fi
        
        echo "" >> security-summary.md
        echo "## Node.js Security Scan" >> security-summary.md
        if [ -f "security-reports/nodejs-security-reports/npm-audit-report.json" ]; then
          echo "- âœ… NPM audit completed" >> security-summary.md
        else
          echo "- âŒ NPM audit failed or not run" >> security-summary.md
        fi
        
        echo "" >> security-summary.md
        echo "## Container Security Scan" >> security-summary.md
        echo "- âœ… Trivy container scans completed for base images" >> security-summary.md
        
        echo "" >> security-summary.md
        echo "## Recommendations" >> security-summary.md
        echo "1. Review all high-severity vulnerabilities" >> security-summary.md
        echo "2. Update dependencies with security patches" >> security-summary.md
        echo "3. Follow up on any failed scans" >> security-summary.md
        echo "4. Check GitHub Security tab for detailed reports" >> security-summary.md

    - name: ğŸ“Š Upload Summary Report
      uses: actions/upload-artifact@v4
      with:
        name: security-summary-report
        path: security-summary.md

    - name: ğŸ’¬ Comment on Latest Commit
      if: github.event_name == 'push'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('security-summary.md')) {
            const summary = fs.readFileSync('security-summary.md', 'utf8');
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: \`## ğŸ”’ è‡ªåŠ¨å®‰å…¨æ‰«æç»“æœ\\n\\n\${summary}\\n\\næŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šè¯·è®¿é—® [Actions é¡µé¢](\${context.payload.repository.html_url}/actions/runs/\${context.runId})\`
            });
          }