<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端下载功能测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .step {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .step.success {
            border-color: #28a745;
            background: #f8fff9;
        }
        .step.error {
            border-color: #dc3545;
            background: #fff8f8;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success-text { color: #28a745; }
        .error-text { color: #dc3545; }
        .info-text { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎬 前端影片下载功能测试</h1>
        
        <div class="step" id="step1">
            <h3>步骤 1: 模拟完整项目数据</h3>
            <p>创建包含所有必要元素的项目数据（脚本、图像、音频）</p>
            <button onclick="setupProjectData()">设置项目数据</button>
            <div class="log" id="log1"></div>
        </div>

        <div class="step" id="step2">
            <h3>步骤 2: 调用影片生成API</h3>
            <p>使用项目数据调用后端影片生成API</p>
            <button onclick="generateVideo()" id="generateBtn" disabled>生成影片</button>
            <div class="log" id="log2"></div>
        </div>

        <div class="step" id="step3">
            <h3>步骤 3: 测试下载功能</h3>
            <p>测试前端下载按钮功能，获取下载链接</p>
            <button onclick="downloadVideo()" id="downloadBtn" disabled>下载影片</button>
            <div class="log" id="log3"></div>
        </div>

        <div class="step" id="step4">
            <h3>步骤 4: 验证整体流程</h3>
            <p>验证从项目创建到影片下载的完整流程</p>
            <button onclick="runFullTest()" id="fullTestBtn">运行完整测试</button>
            <div class="log" id="log4"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';
        let projectData = {};
        let videoData = {};

        function log(stepId, message, type = 'info') {
            const logElement = document.getElementById(`log${stepId}`);
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'success' ? 'success-text' : type === 'error' ? 'error-text' : 'info-text';
            logElement.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function setStepStatus(stepId, status) {
            const step = document.getElementById(`step${stepId}`);
            step.className = `step ${status}`;
        }

        function setupProjectData() {
            try {
                projectData = {
                    title: 'AI技术教学影片测试',
                    script: '欢迎来到AI技术教学的精彩世界！在今天的内容中，我们将探索AI技术的各个面向，为您带来最新的资讯和深入的见解。无论您是初学者还是专家，这个内容都将为您提供有价值的知识和实用的建议。',
                    images: [
                        { id: 1, url: 'https://picsum.photos/800/600?random=1', type: 'thumbnail', prompt: 'AI教学影片缩图' },
                        { id: 2, url: 'https://picsum.photos/800/600?random=2', type: 'background', prompt: '背景场景1' },
                        { id: 3, url: 'https://picsum.photos/800/600?random=3', type: 'background', prompt: '背景场景2' },
                        { id: 4, url: 'https://picsum.photos/800/600?random=4', type: 'overlay', prompt: '覆盖图形' }
                    ],
                    audio: {
                        url: 'https://example.com/audio/voice_test.mp3',
                        duration: 45,
                        voice: 'Alloy'
                    },
                    duration: 60,
                    platform: 'youtube',
                    resolution: '1920x1080'
                };

                log(1, '✅ 项目数据设置成功', 'success');
                log(1, `   标题: ${projectData.title}`, 'info');
                log(1, `   脚本长度: ${projectData.script.length} 字符`, 'info');
                log(1, `   图像数量: ${projectData.images.length} 张`, 'info');
                log(1, `   音频时长: ${projectData.audio.duration} 秒`, 'info');
                
                setStepStatus(1, 'success');
                document.getElementById('generateBtn').disabled = false;
            } catch (error) {
                log(1, `❌ 项目数据设置失败: ${error.message}`, 'error');
                setStepStatus(1, 'error');
            }
        }

        async function generateVideo() {
            try {
                log(2, '🎬 开始调用影片生成API...', 'info');
                
                const response = await fetch(`${API_BASE}/api/v1/generate/video`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        project_data: projectData
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    videoData = result.data;
                    log(2, '✅ 影片生成成功', 'success');
                    log(2, `   影片ID: ${videoData.video_id}`, 'info');
                    log(2, `   标题: ${videoData.title}`, 'info');
                    log(2, `   档案大小: ${videoData.fileSize}`, 'info');
                    log(2, `   解析度: ${videoData.resolution}`, 'info');
                    log(2, `   格式: ${videoData.format}`, 'info');
                    
                    setStepStatus(2, 'success');
                    document.getElementById('downloadBtn').disabled = false;
                } else {
                    throw new Error(result.error || 'API返回错误');
                }
            } catch (error) {
                log(2, `❌ 影片生成失败: ${error.message}`, 'error');
                setStepStatus(2, 'error');
            }
        }

        async function downloadVideo() {
            if (!videoData.video_id) {
                log(3, '❌ 没有可下载的影片', 'error');
                return;
            }

            try {
                log(3, '📥 开始获取下载链接...', 'info');
                
                const response = await fetch(`${API_BASE}/api/v1/videos/${videoData.video_id}/download`);
                const result = await response.json();

                if (response.ok && result.success) {
                    log(3, '✅ 下载链接获取成功', 'success');
                    log(3, `   文件名: ${result.data.filename}`, 'info');
                    log(3, `   文件大小: ${result.data.size}`, 'info');
                    log(3, `   下载URL: ${result.data.download_url}`, 'info');
                    log(3, `   过期时间: ${result.data.expires_at}`, 'info');
                    
                    // 模拟前端下载过程（不实际下载文件）
                    log(3, '🔄 模拟下载过程...', 'info');
                    
                    setTimeout(() => {
                        log(3, '✅ 下载功能测试完成（模拟模式）', 'success');
                        log(3, '💡 在实际环境中会触发文件下载', 'info');
                        setStepStatus(3, 'success');
                    }, 1500);
                } else {
                    throw new Error(result.error || '获取下载链接失败');
                }
            } catch (error) {
                log(3, `❌ 下载功能测试失败: ${error.message}`, 'error');
                setStepStatus(3, 'error');
            }
        }

        async function runFullTest() {
            log(4, '🚀 开始运行完整流程测试...', 'info');
            
            // 重置状态
            projectData = {};
            videoData = {};
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('downloadBtn').disabled = true;
            
            try {
                // 步骤1: 设置项目数据
                log(4, '📋 步骤1: 设置项目数据', 'info');
                setupProjectData();
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 步骤2: 生成影片
                log(4, '🎬 步骤2: 生成影片', 'info');
                await generateVideo();
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 步骤3: 下载影片
                log(4, '📥 步骤3: 下载影片', 'info');
                await downloadVideo();
                await new Promise(resolve => setTimeout(resolve, 2000));

                log(4, '🎉 完整流程测试成功！', 'success');
                log(4, '✅ 所有功能正常运行', 'success');
                log(4, '💡 用户现在可以在 /create 页面使用完整功能', 'info');
                
                setStepStatus(4, 'success');
            } catch (error) {
                log(4, `❌ 完整流程测试失败: ${error.message}`, 'error');
                setStepStatus(4, 'error');
            }
        }
    </script>
</body>
</html>